<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>macOS Simulator</title>

    <!-- External Resources for World-Class Simulator -->
    <!-- Leaflet for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Chart.js for Stocks -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        /* CSS Variables */
        :root {
            --macos-blue: #007AFF;
            --menu-bar-height: 24px;
            --dock-height: 70px;
            --window-shadow: 0 10px 50px rgba(0,0,0,0.3);
            --border-radius: 10px;
            --transition-speed: 0.3s;
            --blur-amount: 20px;

            /* Light mode colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --border-color: #d2d2d7;
            --menu-bg: rgba(255, 255, 255, 0.8);
            --dock-bg: rgba(255, 255, 255, 0.3);
        }

        [data-theme="dark"] {
            --bg-primary: #1e1e1e;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #a1a1a6;
            --border-color: #3d3d3d;
            --menu-bg: rgba(30, 30, 30, 0.8);
            --dock-bg: rgba(30, 30, 30, 0.3);
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
        }

        /* Desktop */
        #desktop {
            position: absolute;
            top: var(--menu-bar-height);
            left: 0;
            right: 0;
            bottom: var(--dock-height);
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="1920" height="1080"><defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23667eea"/><stop offset="100%" style="stop-color:%23764ba2"/></linearGradient></defs><rect width="1920" height="1080" fill="url(%23g)"/></svg>');
            background-size: cover;
            background-position: center;
        }

        /* Menu Bar */
        #menu-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: var(--menu-bar-height);
            background: var(--menu-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            font-size: 13px;
            font-weight: 500;
            z-index: 10000;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .menu-left, .menu-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-item {
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 4px;
            position: relative;
            transition: background 0.15s;
        }

        .menu-item:hover {
            background: rgba(0,0,0,0.1);
        }

        .apple-logo {
            font-size: 16px;
        }

        .menu-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--menu-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border: 1px solid var(--border-color);
            border-radius: 6px;
            min-width: 200px;
            padding: 4px;
            margin-top: 4px;
            display: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 10001;
        }

        .menu-dropdown.active {
            display: block;
        }

        .dropdown-item {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.1s;
        }

        .dropdown-item:hover {
            background: var(--macos-blue);
            color: white;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        #clock {
            font-variant-numeric: tabular-nums;
        }

        /* Dock */
        #dock {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dock-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 5px 15px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            z-index: 9999;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }

        .dock-item {
            width: 50px;
            height: 50px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border-radius: 10px;
        }

        .dock-item:hover {
            transform: translateY(-10px) scale(1.2);
        }

        .dock-item.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: var(--text-primary);
            border-radius: 50%;
        }

        .dock-divider {
            width: 1px;
            height: 50px;
            background: rgba(255,255,255,0.3);
            margin: 0 5px;
        }

        /* Windows Container */
        #windows-container {
            position: absolute;
            top: var(--menu-bar-height);
            left: 0;
            right: 0;
            bottom: var(--dock-height);
            pointer-events: none;
        }

        /* Window */
        .window {
            position: absolute;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            box-shadow: var(--window-shadow);
            overflow: hidden;
            pointer-events: all;
            display: flex;
            flex-direction: column;
        }

        .window.minimized {
            display: none;
        }

        .window.maximized {
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            border-radius: 0;
        }

        .window-titlebar {
            height: 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            cursor: move;
            user-select: none;
        }

        .traffic-lights {
            display: flex;
            gap: 8px;
            margin-right: auto;
        }

        .traffic-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            transition: filter 0.15s;
        }

        .traffic-light:hover {
            filter: brightness(1.2);
        }

        .traffic-light.close { background: #ff5f57; }
        .traffic-light.minimize { background: #ffbd2e; }
        .traffic-light.maximize { background: #28c840; }

        .traffic-light:hover::before {
            position: absolute;
            font-size: 8px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(0,0,0,0.5);
        }

        .traffic-light.close:hover::before { content: '×'; font-size: 12px; }
        .traffic-light.minimize:hover::before { content: '−'; }
        .traffic-light.maximize:hover::before { content: '+'; }

        .window-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            font-weight: 600;
        }

        .window-content {
            flex: 1;
            overflow: auto;
            background: var(--bg-primary);
        }

        .window-toolbar {
            height: 48px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
        }

        /* Resize handles */
        .resize-handle {
            position: absolute;
            z-index: 10;
        }

        .resize-n { top: 0; left: 0; right: 0; height: 5px; cursor: ns-resize; }
        .resize-s { bottom: 0; left: 0; right: 0; height: 5px; cursor: ns-resize; }
        .resize-e { top: 0; right: 0; bottom: 0; width: 5px; cursor: ew-resize; }
        .resize-w { top: 0; left: 0; bottom: 0; width: 5px; cursor: ew-resize; }
        .resize-ne { top: 0; right: 0; width: 10px; height: 10px; cursor: nesw-resize; }
        .resize-nw { top: 0; left: 0; width: 10px; height: 10px; cursor: nwse-resize; }
        .resize-se { bottom: 0; right: 0; width: 10px; height: 10px; cursor: nwse-resize; }
        .resize-sw { bottom: 0; left: 0; width: 10px; height: 10px; cursor: nesw-resize; }

        /* Finder Styles */
        .finder-container {
            display: flex;
            height: 100%;
        }

        .finder-sidebar {
            width: 180px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px 10px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            padding: 0 8px;
            margin-bottom: 5px;
        }

        .sidebar-item {
            padding: 5px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .sidebar-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .finder-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .finder-items {
            flex: 1;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 20px;
            align-content: start;
            overflow-y: auto;
        }

        .finder-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.15s;
        }

        .finder-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .finder-item.selected {
            background: var(--macos-blue);
            color: white;
        }

        .finder-icon {
            width: 64px;
            height: 64px;
            background: var(--macos-blue);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .finder-name {
            font-size: 12px;
            text-align: center;
            word-break: break-word;
        }

        .finder-statusbar {
            height: 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Safari Styles */
        .safari-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .safari-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 8px 0 8px;
            gap: 2px;
        }

        .safari-tab {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            padding: 6px 30px 6px 12px;
            cursor: pointer;
            font-size: 12px;
            min-width: 120px;
            max-width: 200px;
            position: relative;
            transition: background 0.15s;
        }

        .safari-tab:not(.active) {
            background: var(--bg-secondary);
        }

        .safari-tab:hover {
            background: var(--bg-primary);
        }

        .safari-tab .close-tab {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            opacity: 0;
            background: rgba(0,0,0,0.1);
        }

        .safari-tab:hover .close-tab {
            opacity: 1;
        }

        .safari-tab .close-tab:hover {
            background: rgba(0,0,0,0.2);
        }

        .new-tab-btn {
            padding: 6px 12px;
            cursor: pointer;
            background: transparent;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .new-tab-btn:hover {
            background: rgba(0,0,0,0.05);
        }

        .safari-navigation {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            gap: 8px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .nav-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: background 0.15s;
        }

        .nav-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .address-bar {
            flex: 1;
            height: 28px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0 12px;
            background: var(--bg-primary);
            font-size: 13px;
            outline: none;
        }

        .address-bar:focus {
            border-color: var(--macos-blue);
        }

        .safari-content {
            flex: 1;
            background: var(--bg-primary);
            overflow-y: auto;
            padding: 20px;
        }

        /* Terminal Styles */
        .terminal-container {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            padding: 15px;
            height: 100%;
            overflow-y: auto;
        }

        .terminal-line {
            margin: 2px 0;
            line-height: 1.5;
        }

        .terminal-prompt {
            color: #00ff00;
        }

        .terminal-input-line {
            display: flex;
            align-items: center;
        }

        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #00ff00;
            font-family: inherit;
            font-size: inherit;
            caret-color: #00ff00;
        }

        /* Calculator Styles */
        .calculator-container {
            background: var(--bg-primary);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .calc-display {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            text-align: right;
            font-size: 48px;
            font-weight: 300;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            word-break: break-all;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .calc-btn {
            height: 60px;
            border: none;
            border-radius: 8px;
            font-size: 24px;
            cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.15s;
        }

        .calc-btn:hover {
            filter: brightness(0.95);
        }

        .calc-btn:active {
            transform: scale(0.95);
        }

        .calc-btn.operator {
            background: var(--macos-blue);
            color: white;
        }

        .calc-btn.function {
            background: #ff9500;
            color: white;
        }

        /* Notes Styles */
        .notes-container {
            display: flex;
            height: 100%;
        }

        .notes-sidebar {
            width: 200px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .notes-list {
            padding: 10px;
        }

        .note-item {
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 5px;
            transition: background 0.15s;
        }

        .note-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .note-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .note-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .note-preview {
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .note-item.active .note-preview {
            color: rgba(255,255,255,0.8);
        }

        .notes-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .notes-content {
            flex: 1;
            padding: 20px;
            border: none;
            outline: none;
            font-size: 15px;
            line-height: 1.6;
            resize: none;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Settings Styles */
        .settings-container {
            display: flex;
            height: 100%;
        }

        .settings-sidebar {
            width: 200px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px 10px;
        }

        .settings-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-bottom: 5px;
            transition: background 0.15s;
        }

        .settings-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .settings-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .settings-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-label {
            font-size: 14px;
        }

        .toggle-switch {
            width: 50px;
            height: 28px;
            background: var(--border-color);
            border-radius: 14px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--macos-blue);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 24px;
        }

        /* Spotlight Styles */
        .spotlight-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 20vh;
            z-index: 20000;
        }

        .spotlight-overlay.active {
            display: flex;
        }

        .spotlight-search {
            background: var(--bg-primary);
            border-radius: 12px;
            width: 600px;
            max-width: 90vw;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .spotlight-input {
            width: 100%;
            padding: 20px;
            border: none;
            outline: none;
            font-size: 32px;
            background: transparent;
            color: var(--text-primary);
        }

        .spotlight-results {
            max-height: 400px;
            overflow-y: auto;
            border-top: 1px solid var(--border-color);
        }

        .spotlight-result {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.15s;
        }

        .spotlight-result:hover,
        .spotlight-result.selected {
            background: var(--macos-blue);
            color: white;
        }

        .spotlight-icon {
            width: 32px;
            height: 32px;
            background: var(--macos-blue);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .spotlight-result:hover .spotlight-icon,
        .spotlight-result.selected .spotlight-icon {
            background: rgba(255,255,255,0.2);
        }

        /* Calendar Styles */
        .calendar-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .calendar-title {
            font-size: 24px;
            font-weight: 600;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            flex: 1;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            color: var(--text-secondary);
            padding: 10px;
        }

        .calendar-day {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.15s;
            min-height: 80px;
        }

        .calendar-day:hover {
            background: rgba(0,122,255,0.1);
            border-color: var(--macos-blue);
        }

        .calendar-day.today {
            background: var(--macos-blue);
            color: white;
            border-color: var(--macos-blue);
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        /* Button Styles */
        .btn {
            padding: 6px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s;
        }

        .btn:hover {
            background: var(--bg-secondary);
        }

        .btn-primary {
            background: var(--macos-blue);
            color: white;
            border-color: var(--macos-blue);
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        /* Utility Classes */
        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 8px;
        }

        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }

        /* Animations */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .bounce {
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Boot Screen Styles */
        .boot-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        .boot-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .boot-logo {
            font-size: 120px;
            margin-bottom: 40px;
            opacity: 0;
            animation: fadeInLogo 1s ease-in-out 0.5s forwards;
        }

        @keyframes fadeInLogo {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .boot-progress {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .boot-progress-bar {
            height: 100%;
            background: white;
            width: 0;
            animation: bootProgress 2s ease-in-out 1s forwards;
        }

        @keyframes bootProgress {
            from { width: 0; }
            to { width: 100%; }
        }

        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="1920" height="1080"><defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23667eea"/><stop offset="100%" style="stop-color:%23764ba2"/></linearGradient></defs><rect width="1920" height="1080" fill="url(%23g)"/></svg>');
            background-size: cover;
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in;
        }

        .login-screen.active {
            opacity: 1;
            pointer-events: all;
        }

        .login-time {
            font-size: 72px;
            font-weight: 200;
            color: white;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .login-date {
            font-size: 24px;
            font-weight: 400;
            color: rgba(255,255,255,0.9);
            margin-bottom: 80px;
            text-shadow: 0 1px 5px rgba(0,0,0,0.3);
        }

        .login-user {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .login-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .login-username {
            font-size: 24px;
            font-weight: 500;
            color: white;
            margin-bottom: 10px;
            text-shadow: 0 1px 5px rgba(0,0,0,0.3);
        }

        .login-password {
            width: 300px;
            padding: 12px 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 16px;
            outline: none;
            text-align: center;
            transition: all 0.3s;
        }

        .login-password:focus {
            border-color: rgba(255,255,255,0.6);
            background: rgba(255,255,255,0.25);
        }

        .login-password::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .login-button {
            margin-top: 10px;
            padding: 10px 40px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-button:hover {
            background: rgba(255,255,255,0.35);
            transform: scale(1.05);
        }

        .login-power {
            position: absolute;
            bottom: 40px;
            display: flex;
            gap: 30px;
        }

        .power-btn {
            width: 50px;
            height: 50px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .power-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.1);
        }

        /* Desktop Icons */
        .desktop-icon {
            position: absolute;
            width: 80px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.15s;
            user-select: none;
        }

        .desktop-icon:hover {
            background: rgba(255,255,255,0.15);
        }

        .desktop-icon.selected {
            background: rgba(0,122,255,0.3);
        }

        .desktop-icon-img {
            font-size: 48px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .desktop-icon-name {
            font-size: 12px;
            color: white;
            text-align: center;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            word-break: break-word;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--menu-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border: 1px solid var(--border-color);
            border-radius: 6px;
            min-width: 200px;
            padding: 4px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 15000;
            display: none;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.1s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .context-menu-item:hover {
            background: var(--macos-blue);
            color: white;
        }

        .context-menu-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .context-menu-item.disabled:hover {
            background: transparent;
            color: var(--text-primary);
        }

        .context-menu-shortcut {
            font-size: 11px;
            opacity: 0.7;
            margin-left: 20px;
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* Music App Styles */
        .music-container {
            display: flex;
            height: 100%;
            background: var(--bg-primary);
        }

        .music-sidebar {
            width: 200px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px 10px;
        }

        .music-nav-item {
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .music-nav-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .music-nav-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .music-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .music-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .music-grid {
            flex: 1;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            overflow-y: auto;
        }

        .music-item {
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center;
        }

        .music-item:hover {
            transform: scale(1.05);
        }

        .music-item img {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            object-fit: cover;
        }

        .music-item-title {
            font-weight: 600;
            margin-top: 10px;
            font-size: 13px;
        }

        .music-item-artist {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .music-player {
            height: 100px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 250px;
        }

        .player-info img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
        }

        .player-text {
            flex: 1;
        }

        #player-title {
            font-weight: 600;
            font-size: 14px;
        }

        #player-artist {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .player-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .player-controls button {
            background: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .player-controls button:hover {
            background: rgba(0,0,0,0.1);
        }

        #play-pause-btn {
            font-size: 24px;
        }

        .player-progress {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #progress-bar {
            flex: 1;
        }

        .player-volume {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 150px;
        }

        #volume-slider {
            flex: 1;
        }

        /* Photos App Styles */
        .photos-container {
            display: flex;
            height: 100%;
            background: var(--bg-primary);
        }

        .photos-sidebar {
            width: 200px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px 10px;
        }

        .photos-nav-item {
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .photos-nav-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .photos-nav-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .photos-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .photos-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .photos-header button {
            padding: 8px 16px;
            background: var(--macos-blue);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .photos-grid {
            flex: 1;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            overflow-y: auto;
        }

        .photo-item {
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .photo-item:hover {
            transform: scale(1.05);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-viewer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #viewer-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .photo-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 30px;
            padding: 20px 15px;
            cursor: pointer;
            border-radius: 4px;
        }

        .photo-nav.prev { left: 20px; }
        .photo-nav.next { right: 20px; }

        .photo-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            color: white;
            font-size: 40px;
            cursor: pointer;
        }

        /* Maps App Styles */
        .maps-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .maps-search-bar {
            padding: 15px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        #maps-search {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
        }

        .maps-search-bar button {
            padding: 10px 20px;
            background: var(--macos-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Weather App Styles */
        .weather-container {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }

        .weather-search {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        #weather-city {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
        }

        .weather-search button {
            padding: 10px 20px;
            background: var(--macos-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .weather-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
        }

        .weather-main {
            text-align: center;
            margin-bottom: 30px;
        }

        .weather-temp {
            font-size: 72px;
            font-weight: 200;
            margin: 20px 0;
        }

        .weather-desc {
            font-size: 24px;
            text-transform: capitalize;
            margin-bottom: 10px;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 30px;
        }

        .weather-detail-item {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .weather-detail-item h4 {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .weather-detail-item p {
            font-size: 24px;
            font-weight: 600;
        }

        /* Stocks App Styles */
        .stocks-container {
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .stocks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .stocks-header button {
            padding: 8px 16px;
            background: var(--macos-blue);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .stocks-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .stock-item {
            background: var(--bg-secondary);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stock-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .stock-info p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .stock-price {
            text-align: right;
        }

        .stock-price-value {
            font-size: 24px;
            font-weight: 600;
        }

        .stock-change {
            font-size: 14px;
            margin-top: 5px;
        }

        .stock-change.positive {
            color: #28c840;
        }

        .stock-change.negative {
            color: #ff5f57;
        }

        .stocks-chart {
            height: 200px;
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 20px;
        }

        /* News App Styles */
        .news-container {
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .news-header button {
            padding: 8px 16px;
            background: var(--macos-blue);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .news-content {
            flex: 1;
            overflow-y: auto;
        }

        .news-item {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .news-item:hover {
            transform: translateX(5px);
        }

        .news-item h3 {
            font-size: 18px;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .news-item p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .news-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Videos App Styles */
        .videos-container {
            height: 100%;
            background: var(--bg-primary);
        }

        .videos-library {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .video-thumb {
            cursor: pointer;
            transition: transform 0.2s;
            border-radius: 10px;
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .video-thumb:hover {
            transform: scale(1.05);
        }

        .video-thumb img {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
        }

        .video-thumb-info {
            padding: 15px;
        }

        .video-thumb-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .video-thumb-duration {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .video-player-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: #000;
        }

        #video-player {
            max-width: 100%;
            max-height: calc(100% - 60px);
            border-radius: 10px;
        }

        .back-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background: var(--macos-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .weather-loading, .stocks-loading, .news-loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Boot Screen -->
    <div class="boot-screen" id="boot-screen">
        <div class="boot-logo">
            <svg width="120" height="120" viewBox="0 0 814 1000" xmlns="http://www.w3.org/2000/svg" fill="white">
                <path d="M788.1 340.9c-5.8 4.5-108.2 62.2-108.2 190.5 0 148.4 130.3 200.9 134.2 202.2-.6 3.2-20.7 71.9-68.7 141.9-42.8 61.6-87.5 123.1-155.5 123.1s-85.5-39.5-164-39.5c-76.5 0-103.7 40.8-165.9 40.8s-105.6-57-155.5-127C46.7 790.7 0 663 0 541.8c0-194.4 126.4-297.5 250.8-297.5 66.1 0 121.2 43.4 162.7 43.4 39.5 0 101.1-46 176.3-46 28.5 0 130.9 2.6 198.3 99.2zm-234-181.5c31.1-36.9 53.1-88.1 53.1-139.3 0-7.1-.6-14.3-1.9-20.1-50.6 1.9-110.8 33.7-147.1 75.8-28.5 32.4-55.1 83.6-55.1 135.5 0 7.8 1.3 15.6 1.9 18.1 3.2.6 8.4 1.3 13.6 1.3 45.4 0 102.5-30.4 135.5-71.3z"/>
            </svg>
        </div>
        <div class="boot-progress">
            <div class="boot-progress-bar"></div>
        </div>
    </div>

    <!-- Login Screen -->
    <div class="login-screen" id="login-screen">
        <div class="login-time" id="login-time">12:00</div>
        <div class="login-date" id="login-date">Monday, November 18</div>
        <div class="login-user">
            <div class="login-avatar">👤</div>
            <div class="login-username">User</div>
            <input type="password" class="login-password" id="login-password" placeholder="Enter Password" autocomplete="off">
            <button class="login-button" onclick="performLogin()">Login</button>
        </div>
        <div class="login-power">
            <div class="power-btn" onclick="systemSleep()" title="Sleep">💤</div>
            <div class="power-btn" onclick="systemRestart()" title="Restart">🔄</div>
            <div class="power-btn" onclick="systemShutdown()" title="Shut Down">⏻</div>
        </div>
    </div>

    <!-- Desktop -->
    <div id="desktop"></div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu"></div>

    <!-- Menu Bar -->
    <div id="menu-bar">
        <div class="menu-left">
            <div class="menu-item apple-logo">
                <svg width="14" height="17" viewBox="0 0 814 1000" xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="vertical-align: middle;">
                    <path d="M788.1 340.9c-5.8 4.5-108.2 62.2-108.2 190.5 0 148.4 130.3 200.9 134.2 202.2-.6 3.2-20.7 71.9-68.7 141.9-42.8 61.6-87.5 123.1-155.5 123.1s-85.5-39.5-164-39.5c-76.5 0-103.7 40.8-165.9 40.8s-105.6-57-155.5-127C46.7 790.7 0 663 0 541.8c0-194.4 126.4-297.5 250.8-297.5 66.1 0 121.2 43.4 162.7 43.4 39.5 0 101.1-46 176.3-46 28.5 0 130.9 2.6 198.3 99.2zm-234-181.5c31.1-36.9 53.1-88.1 53.1-139.3 0-7.1-.6-14.3-1.9-20.1-50.6 1.9-110.8 33.7-147.1 75.8-28.5 32.4-55.1 83.6-55.1 135.5 0 7.8 1.3 15.6 1.9 18.1 3.2.6 8.4 1.3 13.6 1.3 45.4 0 102.5-30.4 135.5-71.3z"/>
                </svg>
                <div class="menu-dropdown" id="apple-menu">
                    <div class="dropdown-item" onclick="showAboutMac()">About This Mac</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="launchApp('settings')">System Settings...</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="systemSleep()">Sleep</div>
                    <div class="dropdown-item" onclick="systemRestart()">Restart...</div>
                    <div class="dropdown-item" onclick="systemShutdown()">Shut Down...</div>
                </div>
            </div>
            <div class="menu-item" id="app-menu-name">Finder</div>
        </div>
        <div class="menu-right">
            <div class="menu-item" onclick="toggleSpotlight()">🔍</div>
            <div class="menu-item">🔋</div>
            <div class="menu-item">📶</div>
            <div class="menu-item" id="clock">12:00 PM</div>
        </div>
    </div>

    <!-- Windows Container -->
    <div id="windows-container"></div>

    <!-- Dock -->
    <div id="dock">
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%2300a2ff%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>📁</text></svg>')" data-app="finder"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><defs><linearGradient id=%22safari%22 x1=%220%22 y1=%220%22 x2=%221%22 y2=%221%22><stop offset=%220%25%22 stop-color=%22%2300c0ff%22/><stop offset=%22100%25%22 stop-color=%22%230080ff%22/></linearGradient></defs><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22url(%23safari)%22/><text x=%2250%22 y=%2270%22 font-size=%2250%22 text-anchor=%22middle%22 fill=%22white%22>🧭</text></svg>')" data-app="safari"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%231e1e1e%22 rx=%2215%22/><text x=%2250%22 y=%2265%22 font-size=%2255%22 text-anchor=%22middle%22 fill=%22%2300ff00%22>&gt;_</text></svg>')" data-app="terminal"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23ff9500%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>Σ</text></svg>')" data-app="calculator"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23ffd60a%22 rx=%2215%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>📝</text></svg>')" data-app="notes"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23ff3b30%22 rx=%2215%22/><text x=%2250%22 y=%2275%22 font-size=%2270%22 text-anchor=%22middle%22 fill=%22white%22>📅</text></svg>')" data-app="calendar"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23a0a0a0%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>⚙️</text></svg>')" data-app="settings"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><defs><linearGradient id=%22music%22 x1=%220%22 y1=%220%22 x2=%221%22 y2=%221%22><stop offset=%220%25%22 stop-color=%22%23ff006e%22/><stop offset=%22100%25%22 stop-color=%22%23d40058%22/></linearGradient></defs><rect width=%22100%22 height=%22100%22 fill=%22url(%23music)%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>🎵</text></svg>')" data-app="music"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><defs><linearGradient id=%22photos%22 x1=%220%22 y1=%220%22 x2=%221%22 y2=%221%22><stop offset=%220%25%22 stop-color=%22%23ffcc00%22/><stop offset=%22100%25%22 stop-color=%22%23ff9900%22/></linearGradient></defs><rect width=%22100%22 height=%22100%22 fill=%22url(%23photos)%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>🖼️</text></svg>')" data-app="photos"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%2300d856%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>🗺️</text></svg>')" data-app="maps"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><defs><linearGradient id=%22weather%22 x1=%220%22 y1=%220%22 x2=%220%22 y2=%221%22><stop offset=%220%25%22 stop-color=%22%2354b6f8%22/><stop offset=%22100%25%22 stop-color=%22%231a7ec8%22/></linearGradient></defs><rect width=%22100%22 height=%22100%22 fill=%22url(%23weather)%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>☀️</text></svg>')" data-app="weather"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23000%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22%2300ff00%22>📈</text></svg>')" data-app="stocks"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23ff3b30%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>📰</text></svg>')" data-app="news"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23007aff%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>🎬</text></svg>')" data-app="videos"></div>

        <div class="dock-divider"></div>

        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23666%22 rx=%2215%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>📥</text></svg>')"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23888%22 rx=%2215%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>🗑️</text></svg>')"></div>
    </div>

    <!-- Spotlight Overlay -->
    <div class="spotlight-overlay" id="spotlight">
        <div class="spotlight-search">
            <input type="text" class="spotlight-input" id="spotlight-input" placeholder="Spotlight Search">
            <div class="spotlight-results" id="spotlight-results"></div>
        </div>
    </div>

    <script>
        // Global State
        const state = {
            windows: [],
            activeWindow: null,
            nextZIndex: 100,
            theme: 'light',
            fileSystem: {
                '/': {
                    'Desktop': {
                        type: 'folder',
                        contents: {
                            'Project Files': { type: 'folder', contents: {} },
                            'Screenshot.png': { type: 'file' }
                        }
                    },
                    'Documents': {
                        type: 'folder',
                        contents: {
                            'Resume.pdf': { type: 'file' },
                            'Work': { type: 'folder', contents: {} }
                        }
                    },
                    'Downloads': {
                        type: 'folder',
                        contents: {
                            'installer.dmg': { type: 'file' },
                            'document.pdf': { type: 'file' }
                        }
                    },
                    'Applications': {
                        type: 'folder',
                        contents: {
                            'Safari': { type: 'app' },
                            'Terminal': { type: 'app' },
                            'Calculator': { type: 'app' },
                            'Notes': { type: 'app' }
                        }
                    }
                }
            },
            terminal: {
                currentDir: '~',
                history: [],
                historyIndex: -1
            },
            notes: [
                { id: 1, title: 'Welcome to Notes', content: 'This is your first note. Start typing to edit!' },
                { id: 2, title: 'Shopping List', content: '• Milk\n• Eggs\n• Bread\n• Coffee' },
                { id: 3, title: 'Meeting Notes', content: 'Team meeting at 2 PM\nDiscuss project roadmap\nReview Q4 goals' },
                { id: 4, title: 'Ideas', content: 'Great ideas start here...' }
            ],
            activeNote: 1,
            calculator: {
                display: '0',
                previousValue: null,
                operation: null,
                waitingForOperand: false
            },
            safari: {
                tabs: [
                    { id: 1, title: 'Apple', url: 'https://www.apple.com', active: true }
                ],
                history: [],
                nextTabId: 2
            }
        };

        // Window Management
        class WindowManager {
            static createWindow(app) {
                const windowId = 'window-' + Date.now();
                const window = document.createElement('div');
                window.className = 'window fade-in';
                window.id = windowId;
                window.style.left = (100 + state.windows.length * 30) + 'px';
                window.style.top = (50 + state.windows.length * 30) + 'px';
                window.style.width = app.width || '800px';
                window.style.height = app.height || '600px';
                window.style.zIndex = state.nextZIndex++;

                window.innerHTML = `
                    <div class="window-titlebar">
                        <div class="traffic-lights">
                            <div class="traffic-light close" onclick="WindowManager.closeWindow('${windowId}')"></div>
                            <div class="traffic-light minimize" onclick="WindowManager.minimizeWindow('${windowId}')"></div>
                            <div class="traffic-light maximize" onclick="WindowManager.toggleMaximize('${windowId}')"></div>
                        </div>
                        <div class="window-title">${app.name}</div>
                    </div>
                    ${app.toolbar ? `<div class="window-toolbar">${app.toolbar}</div>` : ''}
                    <div class="window-content" id="${windowId}-content"></div>
                    <div class="resize-handle resize-n"></div>
                    <div class="resize-handle resize-s"></div>
                    <div class="resize-handle resize-e"></div>
                    <div class="resize-handle resize-w"></div>
                    <div class="resize-handle resize-ne"></div>
                    <div class="resize-handle resize-nw"></div>
                    <div class="resize-handle resize-se"></div>
                    <div class="resize-handle resize-sw"></div>
                `;

                document.getElementById('windows-container').appendChild(window);

                // Render app content
                const content = document.getElementById(`${windowId}-content`);
                app.render(content);

                // Add drag functionality
                this.makeDraggable(window);
                this.makeResizable(window);

                // Add to state
                state.windows.push({
                    id: windowId,
                    appId: app.id,
                    element: window
                });

                this.setActiveWindow(windowId);
                this.updateDock();

                // Focus window on click
                window.addEventListener('mousedown', () => {
                    this.setActiveWindow(windowId);
                });

                return windowId;
            }

            static closeWindow(windowId) {
                const window = document.getElementById(windowId);
                if (window) {
                    window.remove();
                    state.windows = state.windows.filter(w => w.id !== windowId);
                    this.updateDock();
                }
            }

            static minimizeWindow(windowId) {
                const window = document.getElementById(windowId);
                if (window) {
                    window.classList.add('minimized');
                }
            }

            static toggleMaximize(windowId) {
                const window = document.getElementById(windowId);
                if (window) {
                    window.classList.toggle('maximized');
                }
            }

            static setActiveWindow(windowId) {
                state.windows.forEach(w => {
                    if (w.id === windowId) {
                        w.element.style.zIndex = state.nextZIndex++;
                        state.activeWindow = windowId;
                    }
                });
            }

            static getNextZIndex() {
                return state.nextZIndex++;
            }

            static makeDraggable(window) {
                const titlebar = window.querySelector('.window-titlebar');
                let isDragging = false;
                let currentX;
                let currentY;
                let initialX;
                let initialY;

                const onMouseDown = (e) => {
                    if (e.target.classList.contains('traffic-light')) return;
                    if (window.classList.contains('maximized')) return;

                    isDragging = true;
                    initialX = e.clientX - window.offsetLeft;
                    initialY = e.clientY - window.offsetTop;

                    // Bring window to front
                    window.style.zIndex = WindowManager.getNextZIndex();
                };

                const onMouseMove = (e) => {
                    if (isDragging) {
                        e.preventDefault();
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;

                        // Keep window within bounds
                        const maxX = window.parentElement.offsetWidth - 100;
                        const maxY = window.parentElement.offsetHeight - 100;
                        currentX = Math.max(0, Math.min(currentX, maxX));
                        currentY = Math.max(0, Math.min(currentY, maxY));

                        window.style.left = currentX + 'px';
                        window.style.top = currentY + 'px';
                    }
                };

                const onMouseUp = () => {
                    isDragging = false;
                };

                titlebar.addEventListener('mousedown', onMouseDown);
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }

            static makeResizable(window) {
                const handles = window.querySelectorAll('.resize-handle');
                handles.forEach(handle => {
                    let isResizing = false;
                    let startX, startY, startWidth, startHeight, startLeft, startTop;

                    handle.addEventListener('mousedown', (e) => {
                        if (window.classList.contains('maximized')) return;
                        isResizing = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        startWidth = parseInt(window.style.width);
                        startHeight = parseInt(window.style.height);
                        startLeft = window.offsetLeft;
                        startTop = window.offsetTop;
                        e.stopPropagation();
                    });

                    document.addEventListener('mousemove', (e) => {
                        if (!isResizing) return;
                        e.preventDefault();

                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;

                        if (handle.classList.contains('resize-e')) {
                            window.style.width = (startWidth + dx) + 'px';
                        } else if (handle.classList.contains('resize-s')) {
                            window.style.height = (startHeight + dy) + 'px';
                        } else if (handle.classList.contains('resize-se')) {
                            window.style.width = (startWidth + dx) + 'px';
                            window.style.height = (startHeight + dy) + 'px';
                        } else if (handle.classList.contains('resize-w')) {
                            window.style.width = (startWidth - dx) + 'px';
                            window.style.left = (startLeft + dx) + 'px';
                        } else if (handle.classList.contains('resize-n')) {
                            window.style.height = (startHeight - dy) + 'px';
                            window.style.top = (startTop + dy) + 'px';
                        } else if (handle.classList.contains('resize-nw')) {
                            window.style.width = (startWidth - dx) + 'px';
                            window.style.height = (startHeight - dy) + 'px';
                            window.style.left = (startLeft + dx) + 'px';
                            window.style.top = (startTop + dy) + 'px';
                        } else if (handle.classList.contains('resize-ne')) {
                            window.style.width = (startWidth + dx) + 'px';
                            window.style.height = (startHeight - dy) + 'px';
                            window.style.top = (startTop + dy) + 'px';
                        } else if (handle.classList.contains('resize-sw')) {
                            window.style.width = (startWidth - dx) + 'px';
                            window.style.height = (startHeight + dy) + 'px';
                            window.style.left = (startLeft + dx) + 'px';
                        }
                    });

                    document.addEventListener('mouseup', () => {
                        isResizing = false;
                    });
                });
            }

            static updateDock() {
                document.querySelectorAll('.dock-item[data-app]').forEach(item => {
                    const appId = item.getAttribute('data-app');
                    const hasWindow = state.windows.some(w => w.appId === appId);
                    if (hasWindow) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
        }

        // Applications
        const apps = {
            finder: {
                id: 'finder',
                name: 'Finder',
                width: '900px',
                height: '600px',
                toolbar: `
                    <button class="btn" onclick="finderBack()">◀</button>
                    <button class="btn" onclick="finderForward()">▶</button>
                    <span style="flex: 1; padding: 0 15px;" id="finder-path">Desktop</span>
                    <button class="btn">⊞</button>
                    <button class="btn">⊟</button>
                    <button class="btn">≣</button>
                `,
                render: (container) => {
                    container.innerHTML = `
                        <div class="finder-container">
                            <div class="finder-sidebar">
                                <div class="sidebar-section">
                                    <div class="sidebar-title">Favorites</div>
                                    <div class="sidebar-item active" onclick="finderNavigate('Desktop')">📱 Desktop</div>
                                    <div class="sidebar-item" onclick="finderNavigate('Documents')">📄 Documents</div>
                                    <div class="sidebar-item" onclick="finderNavigate('Downloads')">📥 Downloads</div>
                                    <div class="sidebar-item" onclick="finderNavigate('Applications')">📦 Applications</div>
                                </div>
                            </div>
                            <div class="finder-main">
                                <div class="finder-items" id="finder-items"></div>
                                <div class="finder-statusbar" id="finder-status">0 items</div>
                            </div>
                        </div>
                    `;
                    finderNavigate('Desktop');
                }
            },
            safari: {
                id: 'safari',
                name: 'Safari',
                width: '1000px',
                height: '700px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="safari-container">
                            <div class="safari-tabs" id="safari-tabs"></div>
                            <div class="safari-navigation">
                                <button class="nav-btn" onclick="safariBack()">◀</button>
                                <button class="nav-btn" onclick="safariForward()">▶</button>
                                <button class="nav-btn" onclick="safariRefresh()">↻</button>
                                <input type="text" class="address-bar" id="address-bar" placeholder="Search or enter website">
                            </div>
                            <div class="safari-content" id="safari-content"></div>
                        </div>
                    `;
                    renderSafariTabs();
                    renderSafariContent();

                    document.getElementById('address-bar').addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            safariNavigate(e.target.value);
                        }
                    });
                }
            },
            terminal: {
                id: 'terminal',
                name: 'Terminal',
                width: '700px',
                height: '500px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="terminal-container" id="terminal-output">
                            <div class="terminal-line">Last login: ${new Date().toLocaleString()} on ttys000</div>
                            <div class="terminal-line">macOS Simulator Terminal v1.0</div>
                            <div class="terminal-line">Type 'help' for available commands.</div>
                            <div class="terminal-line"></div>
                            <div class="terminal-input-line">
                                <span class="terminal-prompt">user@macos ~ % </span>
                                <input type="text" class="terminal-input" id="terminal-input" autofocus>
                            </div>
                        </div>
                    `;

                    const input = document.getElementById('terminal-input');
                    input.addEventListener('keydown', handleTerminalInput);
                    input.focus();
                }
            },
            calculator: {
                id: 'calculator',
                name: 'Calculator',
                width: '320px',
                height: '500px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="calculator-container">
                            <div class="calc-display" id="calc-display">0</div>
                            <div class="calc-buttons">
                                <button class="calc-btn function" onclick="calcClear()">AC</button>
                                <button class="calc-btn function" onclick="calcToggleSign()">±</button>
                                <button class="calc-btn function" onclick="calcPercent()">%</button>
                                <button class="calc-btn operator" onclick="calcOperation('÷')">÷</button>

                                <button class="calc-btn" onclick="calcNumber('7')">7</button>
                                <button class="calc-btn" onclick="calcNumber('8')">8</button>
                                <button class="calc-btn" onclick="calcNumber('9')">9</button>
                                <button class="calc-btn operator" onclick="calcOperation('×')">×</button>

                                <button class="calc-btn" onclick="calcNumber('4')">4</button>
                                <button class="calc-btn" onclick="calcNumber('5')">5</button>
                                <button class="calc-btn" onclick="calcNumber('6')">6</button>
                                <button class="calc-btn operator" onclick="calcOperation('−')">−</button>

                                <button class="calc-btn" onclick="calcNumber('1')">1</button>
                                <button class="calc-btn" onclick="calcNumber('2')">2</button>
                                <button class="calc-btn" onclick="calcNumber('3')">3</button>
                                <button class="calc-btn operator" onclick="calcOperation('+')">+</button>

                                <button class="calc-btn" onclick="calcNumber('0')" style="grid-column: span 2;">0</button>
                                <button class="calc-btn" onclick="calcDecimal()">.</button>
                                <button class="calc-btn operator" onclick="calcEquals()">=</button>
                            </div>
                        </div>
                    `;
                }
            },
            notes: {
                id: 'notes',
                name: 'Notes',
                width: '800px',
                height: '600px',
                toolbar: `
                    <button class="btn" onclick="createNewNote()">+ New Note</button>
                    <button class="btn" onclick="deleteNote()">🗑️ Delete</button>
                `,
                render: (container) => {
                    container.innerHTML = `
                        <div class="notes-container">
                            <div class="notes-sidebar">
                                <div class="notes-list" id="notes-list"></div>
                            </div>
                            <div class="notes-editor">
                                <textarea class="notes-content" id="notes-content" placeholder="Start typing..."></textarea>
                            </div>
                        </div>
                    `;
                    renderNotesList();
                    loadNote(state.activeNote);

                    document.getElementById('notes-content').addEventListener('input', (e) => {
                        saveCurrentNote(e.target.value);
                    });
                }
            },
            settings: {
                id: 'settings',
                name: 'System Settings',
                width: '800px',
                height: '600px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="settings-container">
                            <div class="settings-sidebar">
                                <div class="settings-item active" onclick="showSettings('appearance')">🎨 Appearance</div>
                                <div class="settings-item" onclick="showSettings('desktop')">🖥️ Desktop</div>
                                <div class="settings-item" onclick="showSettings('displays')">📺 Displays</div>
                                <div class="settings-item" onclick="showSettings('sound')">🔊 Sound</div>
                                <div class="settings-item" onclick="showSettings('network')">📶 Network</div>
                            </div>
                            <div class="settings-content" id="settings-content"></div>
                        </div>
                    `;
                    showSettings('appearance');
                }
            },
            calendar: {
                id: 'calendar',
                name: 'Calendar',
                width: '900px',
                height: '650px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <div class="calendar-title" id="calendar-title"></div>
                                <div class="calendar-nav">
                                    <button class="btn" onclick="calendarPrevMonth()">◀</button>
                                    <button class="btn" onclick="calendarToday()">Today</button>
                                    <button class="btn" onclick="calendarNextMonth()">▶</button>
                                </div>
                            </div>
                            <div class="calendar-grid" id="calendar-grid"></div>
                        </div>
                    `;
                    renderCalendar();
                }
            },
            music: {
                id: 'music',
                name: 'Music',
                width: '900px',
                height: '700px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="music-container">
                            <div class="music-sidebar">
                                <div class="music-section">
                                    <div class="music-nav-item active" onclick="switchMusicView('library')">
                                        <i class="fas fa-music"></i> Library
                                    </div>
                                    <div class="music-nav-item" onclick="switchMusicView('playlists')">
                                        <i class="fas fa-list"></i> Playlists
                                    </div>
                                </div>
                            </div>
                            <div class="music-main">
                                <div class="music-header">
                                    <h2>Library</h2>
                                </div>
                                <div class="music-grid" id="music-grid"></div>
                                <div class="music-player" id="music-player">
                                    <div class="player-info">
                                        <img id="player-artwork" src="https://source.unsplash.com/random/60x60?music" alt="Album Art">
                                        <div class="player-text">
                                            <div id="player-title">Not Playing</div>
                                            <div id="player-artist">Select a track</div>
                                        </div>
                                    </div>
                                    <div class="player-controls">
                                        <button onclick="previousTrack()"><i class="fas fa-step-backward"></i></button>
                                        <button id="play-pause-btn" onclick="togglePlay()"><i class="fas fa-play"></i></button>
                                        <button onclick="nextTrack()"><i class="fas fa-step-forward"></i></button>
                                    </div>
                                    <div class="player-progress">
                                        <span id="current-time">0:00</span>
                                        <input type="range" id="progress-bar" min="0" max="100" value="0" onchange="seekAudio(this.value)">
                                        <span id="duration">0:00</span>
                                    </div>
                                    <div class="player-volume">
                                        <i class="fas fa-volume-up"></i>
                                        <input type="range" id="volume-slider" min="0" max="100" value="80" onchange="setVolume(this.value)">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <audio id="audio-player"></audio>
                    `;
                    initMusic();
                }
            },
            photos: {
                id: 'photos',
                name: 'Photos',
                width: '1000px',
                height: '700px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="photos-container">
                            <div class="photos-sidebar">
                                <div class="photos-section">
                                    <div class="photos-nav-item active" onclick="switchPhotosView('all')">
                                        <i class="fas fa-images"></i> All Photos
                                    </div>
                                    <div class="photos-nav-item" onclick="switchPhotosView('nature')">
                                        <i class="fas fa-tree"></i> Nature
                                    </div>
                                    <div class="photos-nav-item" onclick="switchPhotosView('city')">
                                        <i class="fas fa-city"></i> City
                                    </div>
                                    <div class="photos-nav-item" onclick="switchPhotosView('people')">
                                        <i class="fas fa-user"></i> People
                                    </div>
                                    <div class="photos-nav-item" onclick="switchPhotosView('technology')">
                                        <i class="fas fa-laptop"></i> Technology
                                    </div>
                                </div>
                            </div>
                            <div class="photos-main">
                                <div class="photos-header">
                                    <h2 id="photos-title">All Photos</h2>
                                    <button onclick="startSlideshow()"><i class="fas fa-play"></i> Slideshow</button>
                                </div>
                                <div class="photos-grid" id="photos-grid"></div>
                            </div>
                        </div>
                        <div id="photo-viewer" class="photo-viewer" style="display:none;" onclick="closePhotoViewer()">
                            <button class="photo-nav prev" onclick="event.stopPropagation(); prevPhoto()">❮</button>
                            <img id="viewer-image" src="" alt="Photo">
                            <button class="photo-nav next" onclick="event.stopPropagation(); nextPhoto()">❯</button>
                            <button class="photo-close" onclick="closePhotoViewer()">×</button>
                        </div>
                    `;
                    initPhotos();
                }
            },
            maps: {
                id: 'maps',
                name: 'Maps',
                width: '1000px',
                height: '700px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="maps-container">
                            <div class="maps-search-bar">
                                <input type="text" id="maps-search" placeholder="Search for a place..." onkeypress="if(event.key==='Enter') searchLocation()">
                                <button onclick="searchLocation()"><i class="fas fa-search"></i> Search</button>
                                <button onclick="getCurrentLocation()"><i class="fas fa-location-arrow"></i> My Location</button>
                            </div>
                            <div id="map" style="width: 100%; height: calc(100% - 60px);"></div>
                        </div>
                    `;
                    initMap();
                }
            },
            weather: {
                id: 'weather',
                name: 'Weather',
                width: '800px',
                height: '600px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="weather-container">
                            <div class="weather-search">
                                <input type="text" id="weather-city" placeholder="Enter city name..." value="San Francisco">
                                <button onclick="fetchWeather()"><i class="fas fa-search"></i> Search</button>
                            </div>
                            <div class="weather-content" id="weather-content">
                                <div class="weather-loading">Loading weather data...</div>
                            </div>
                        </div>
                    `;
                    fetchWeather();
                }
            },
            stocks: {
                id: 'stocks',
                name: 'Stocks',
                width: '900px',
                height: '650px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="stocks-container">
                            <div class="stocks-header">
                                <h2>My Stocks</h2>
                                <button onclick="refreshStocks()"><i class="fas fa-sync-alt"></i> Refresh</button>
                            </div>
                            <div class="stocks-list" id="stocks-list">
                                <div class="stocks-loading">Loading stock data...</div>
                            </div>
                            <div class="stocks-chart">
                                <canvas id="stocks-chart-canvas"></canvas>
                            </div>
                        </div>
                    `;
                    initStocks();
                }
            },
            news: {
                id: 'news',
                name: 'News',
                width: '900px',
                height: '700px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="news-container">
                            <div class="news-header">
                                <h2>Top Headlines</h2>
                                <button onclick="refreshNews()"><i class="fas fa-sync-alt"></i> Refresh</button>
                            </div>
                            <div class="news-content" id="news-content">
                                <div class="news-loading">Loading news...</div>
                            </div>
                        </div>
                    `;
                    initNews();
                }
            },
            videos: {
                id: 'videos',
                name: 'Videos',
                width: '900px',
                height: '600px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="videos-container">
                            <div class="videos-library" id="videos-library"></div>
                            <div class="video-player-container" id="video-player-container" style="display:none;">
                                <video id="video-player" controls>
                                    <source src="" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                                <button class="back-btn" onclick="closeVideoPlayer()"><i class="fas fa-arrow-left"></i> Back to Library</button>
                            </div>
                        </div>
                    `;
                    initVideos();
                }
            }
        };

        // App Launch
        function launchApp(appId) {
            // Check if app is already open
            const existingWindow = state.windows.find(w => w.appId === appId);
            if (existingWindow) {
                WindowManager.setActiveWindow(existingWindow.id);
                if (existingWindow.element.classList.contains('minimized')) {
                    existingWindow.element.classList.remove('minimized');
                }
                return;
            }

            const app = apps[appId];
            if (app) {
                // Bounce animation
                const dockItem = document.querySelector(`.dock-item[data-app="${appId}"]`);
                if (dockItem) {
                    dockItem.classList.add('bounce');
                    setTimeout(() => dockItem.classList.remove('bounce'), 600);
                }

                WindowManager.createWindow(app);
                document.getElementById('app-menu-name').textContent = app.name;
            }
        }

        // Finder Functions
        let finderCurrentPath = 'Desktop';
        let finderHistory = ['Desktop'];
        let finderHistoryIndex = 0;

        function finderNavigate(path) {
            finderCurrentPath = path;
            finderHistory = finderHistory.slice(0, finderHistoryIndex + 1);
            finderHistory.push(path);
            finderHistoryIndex = finderHistory.length - 1;

            document.getElementById('finder-path').textContent = path;
            const items = state.fileSystem['/'][path]?.contents || {};
            const itemsContainer = document.getElementById('finder-items');

            itemsContainer.innerHTML = '';
            let count = 0;

            for (const [name, item] of Object.entries(items)) {
                count++;
                const icon = item.type === 'folder' ? '📁' : item.type === 'app' ? '📦' : '📄';
                const div = document.createElement('div');
                div.className = 'finder-item';
                div.innerHTML = `
                    <div class="finder-icon">${icon}</div>
                    <div class="finder-name">${name}</div>
                `;
                div.addEventListener('dblclick', () => {
                    if (item.type === 'folder') {
                        finderNavigate(name);
                    }
                });
                itemsContainer.appendChild(div);
            }

            document.getElementById('finder-status').textContent = `${count} items`;

            // Update sidebar active state
            document.querySelectorAll('.finder-sidebar .sidebar-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent.includes(path)) {
                    item.classList.add('active');
                }
            });
        }

        function finderBack() {
            if (finderHistoryIndex > 0) {
                finderHistoryIndex--;
                finderNavigate(finderHistory[finderHistoryIndex]);
            }
        }

        function finderForward() {
            if (finderHistoryIndex < finderHistory.length - 1) {
                finderHistoryIndex++;
                finderNavigate(finderHistory[finderHistoryIndex]);
            }
        }

        // Safari Functions
        function renderSafariTabs() {
            const tabsContainer = document.getElementById('safari-tabs');
            tabsContainer.innerHTML = '';

            state.safari.tabs.forEach(tab => {
                const tabEl = document.createElement('div');
                tabEl.className = 'safari-tab' + (tab.active ? ' active' : '');
                tabEl.innerHTML = `
                    ${tab.title}
                    <span class="close-tab" onclick="closeSafariTab(${tab.id}, event)">×</span>
                `;
                tabEl.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('close-tab')) {
                        activateSafariTab(tab.id);
                    }
                });
                tabsContainer.appendChild(tabEl);
            });

            const newTabBtn = document.createElement('div');
            newTabBtn.className = 'new-tab-btn';
            newTabBtn.textContent = '+';
            newTabBtn.onclick = createSafariTab;
            tabsContainer.appendChild(newTabBtn);
        }

        function renderSafariContent() {
            const activeTab = state.safari.tabs.find(t => t.active);
            if (!activeTab) return;

            const content = document.getElementById('safari-content');
            document.getElementById('address-bar').value = activeTab.url;

            // Simulate different web pages
            if (activeTab.url.includes('apple.com')) {
                content.innerHTML = `
                    <h1>Welcome to Apple</h1>
                    <p>This is a simulated version of apple.com</p>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px;">
                        <div style="padding: 20px; background: var(--bg-secondary); border-radius: 10px;">
                            <h3>MacBook Pro</h3>
                            <p>The most powerful Mac ever.</p>
                        </div>
                        <div style="padding: 20px; background: var(--bg-secondary); border-radius: 10px;">
                            <h3>iPhone 15</h3>
                            <p>So advanced. So beautiful.</p>
                        </div>
                        <div style="padding: 20px; background: var(--bg-secondary); border-radius: 10px;">
                            <h3>AirPods Pro</h3>
                            <p>Rebuilt from the sound up.</p>
                        </div>
                    </div>
                `;
            } else if (activeTab.url.includes('google')) {
                content.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px;">
                        <h1 style="font-size: 72px; margin-bottom: 30px;">Google</h1>
                        <input type="text" placeholder="Search Google or type a URL" style="width: 500px; padding: 15px; border: 1px solid #ddd; border-radius: 24px; font-size: 16px;">
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <h1>Welcome to Safari</h1>
                    <p>Enter a URL or search query in the address bar above.</p>
                    <h2 style="margin-top: 40px;">Favorites</h2>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px;">
                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;" onclick="safariNavigate('https://www.apple.com')">
                            🍎 Apple
                        </div>
                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;" onclick="safariNavigate('https://www.google.com')">
                            🔍 Google
                        </div>
                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                            📰 News
                        </div>
                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                            🎵 Music
                        </div>
                    </div>
                `;
            }
        }

        function createSafariTab() {
            const newTab = {
                id: state.safari.nextTabId++,
                title: 'New Tab',
                url: 'about:blank',
                active: false
            };

            state.safari.tabs.forEach(t => t.active = false);
            newTab.active = true;
            state.safari.tabs.push(newTab);

            renderSafariTabs();
            renderSafariContent();
        }

        function closeSafariTab(tabId, event) {
            event.stopPropagation();
            const index = state.safari.tabs.findIndex(t => t.id === tabId);
            if (index === -1 || state.safari.tabs.length === 1) return;

            const wasActive = state.safari.tabs[index].active;
            state.safari.tabs.splice(index, 1);

            if (wasActive && state.safari.tabs.length > 0) {
                state.safari.tabs[Math.max(0, index - 1)].active = true;
            }

            renderSafariTabs();
            renderSafariContent();
        }

        function activateSafariTab(tabId) {
            state.safari.tabs.forEach(t => t.active = t.id === tabId);
            renderSafariTabs();
            renderSafariContent();
        }

        function safariNavigate(url) {
            const activeTab = state.safari.tabs.find(t => t.active);
            if (!activeTab) return;

            activeTab.url = url;
            if (url.includes('apple.com')) {
                activeTab.title = 'Apple';
            } else if (url.includes('google')) {
                activeTab.title = 'Google';
            } else {
                activeTab.title = 'New Tab';
            }

            renderSafariTabs();
            renderSafariContent();
        }

        function safariBack() {
            // Simplified - would need full history implementation
            console.log('Back');
        }

        function safariForward() {
            console.log('Forward');
        }

        function safariRefresh() {
            renderSafariContent();
        }

        // Terminal Functions
        function handleTerminalInput(e) {
            if (e.key === 'Enter') {
                const input = e.target.value.trim();
                const output = document.getElementById('terminal-output');

                // Add command to history
                state.terminal.history.push(input);
                state.terminal.historyIndex = state.terminal.history.length;

                // Echo command
                const cmdLine = document.createElement('div');
                cmdLine.className = 'terminal-line';
                cmdLine.innerHTML = `<span class="terminal-prompt">user@macos ${state.terminal.currentDir} % </span>${input}`;
                output.insertBefore(cmdLine, output.lastElementChild);

                // Execute command
                const result = executeTerminalCommand(input);
                if (result) {
                    const resultLine = document.createElement('div');
                    resultLine.className = 'terminal-line';
                    resultLine.innerHTML = result;
                    output.insertBefore(resultLine, output.lastElementChild);
                }

                // Clear input
                e.target.value = '';

                // Scroll to bottom
                output.scrollTop = output.scrollHeight;
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (state.terminal.historyIndex > 0) {
                    state.terminal.historyIndex--;
                    e.target.value = state.terminal.history[state.terminal.historyIndex];
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (state.terminal.historyIndex < state.terminal.history.length - 1) {
                    state.terminal.historyIndex++;
                    e.target.value = state.terminal.history[state.terminal.historyIndex];
                } else {
                    state.terminal.historyIndex = state.terminal.history.length;
                    e.target.value = '';
                }
            }
        }

        function executeTerminalCommand(cmd) {
            const parts = cmd.split(' ');
            const command = parts[0];
            const args = parts.slice(1);

            switch (command) {
                case 'help':
                    return `Available commands:
  ls          - list directory contents
  pwd         - print working directory
  cd [dir]    - change directory
  mkdir [dir] - create directory
  touch [file]- create file
  cat [file]  - display file contents
  echo [text] - print text
  clear       - clear terminal
  date        - show current date/time
  whoami      - show current user
  uname -a    - system information
  help        - show this help message`;

                case 'ls':
                    return 'Applications  Desktop  Documents  Downloads  Library  Music  Pictures  Public';

                case 'pwd':
                    return `/Users/user${state.terminal.currentDir !== '~' ? '/' + state.terminal.currentDir : ''}`;

                case 'cd':
                    if (args.length === 0 || args[0] === '~') {
                        state.terminal.currentDir = '~';
                    } else {
                        state.terminal.currentDir = args[0];
                    }
                    return '';

                case 'mkdir':
                    return args.length > 0 ? '' : 'mkdir: missing operand';

                case 'touch':
                    return args.length > 0 ? '' : 'touch: missing file operand';

                case 'cat':
                    return args.length > 0 ? `Contents of ${args[0]}` : 'cat: missing file operand';

                case 'echo':
                    return args.join(' ');

                case 'clear':
                    setTimeout(() => {
                        const output = document.getElementById('terminal-output');
                        output.innerHTML = `
                            <div class="terminal-input-line">
                                <span class="terminal-prompt">user@macos ${state.terminal.currentDir} % </span>
                                <input type="text" class="terminal-input" id="terminal-input" autofocus>
                            </div>
                        `;
                        document.getElementById('terminal-input').addEventListener('keydown', handleTerminalInput);
                        document.getElementById('terminal-input').focus();
                    }, 0);
                    return '';

                case 'date':
                    return new Date().toString();

                case 'whoami':
                    return 'user';

                case 'uname':
                    if (args[0] === '-a') {
                        return 'Darwin MacBook-Pro.local 21.6.0 Darwin Kernel Version 21.6.0 x86_64';
                    }
                    return 'Darwin';

                case '':
                    return '';

                default:
                    return `zsh: command not found: ${command}`;
            }
        }

        // Calculator Functions
        function calcNumber(num) {
            if (state.calculator.waitingForOperand) {
                state.calculator.display = num;
                state.calculator.waitingForOperand = false;
            } else {
                state.calculator.display = state.calculator.display === '0' ? num : state.calculator.display + num;
            }
            updateCalcDisplay();
        }

        function calcOperation(op) {
            const inputValue = parseFloat(state.calculator.display);

            if (state.calculator.previousValue === null) {
                state.calculator.previousValue = inputValue;
            } else if (state.calculator.operation) {
                const result = performCalculation();
                state.calculator.display = String(result);
                state.calculator.previousValue = result;
            }

            state.calculator.waitingForOperand = true;
            state.calculator.operation = op;
            updateCalcDisplay();
        }

        function calcEquals() {
            const result = performCalculation();
            state.calculator.display = String(result);
            state.calculator.previousValue = null;
            state.calculator.operation = null;
            state.calculator.waitingForOperand = true;
            updateCalcDisplay();
        }

        function performCalculation() {
            const inputValue = parseFloat(state.calculator.display);
            const previousValue = state.calculator.previousValue;

            switch (state.calculator.operation) {
                case '+':
                    return previousValue + inputValue;
                case '−':
                    return previousValue - inputValue;
                case '×':
                    return previousValue * inputValue;
                case '÷':
                    return previousValue / inputValue;
                default:
                    return inputValue;
            }
        }

        function calcClear() {
            state.calculator.display = '0';
            state.calculator.previousValue = null;
            state.calculator.operation = null;
            state.calculator.waitingForOperand = false;
            updateCalcDisplay();
        }

        function calcToggleSign() {
            state.calculator.display = String(parseFloat(state.calculator.display) * -1);
            updateCalcDisplay();
        }

        function calcPercent() {
            state.calculator.display = String(parseFloat(state.calculator.display) / 100);
            updateCalcDisplay();
        }

        function calcDecimal() {
            if (!state.calculator.display.includes('.')) {
                state.calculator.display += '.';
                updateCalcDisplay();
            }
        }

        function updateCalcDisplay() {
            const display = document.getElementById('calc-display');
            if (display) {
                display.textContent = state.calculator.display;
            }
        }

        // Notes Functions
        function renderNotesList() {
            const list = document.getElementById('notes-list');
            list.innerHTML = '';

            state.notes.forEach(note => {
                const div = document.createElement('div');
                div.className = 'note-item' + (note.id === state.activeNote ? ' active' : '');
                div.innerHTML = `
                    <div class="note-title">${note.title}</div>
                    <div class="note-preview">${note.content.substring(0, 50)}...</div>
                `;
                div.onclick = () => loadNote(note.id);
                list.appendChild(div);
            });
        }

        function loadNote(noteId) {
            state.activeNote = noteId;
            const note = state.notes.find(n => n.id === noteId);
            if (note) {
                const content = document.getElementById('notes-content');
                if (content) {
                    content.value = note.content;
                }
                renderNotesList();
            }
        }

        function saveCurrentNote(content) {
            const note = state.notes.find(n => n.id === state.activeNote);
            if (note) {
                note.content = content;
                // Update title from first line
                const firstLine = content.split('\n')[0];
                if (firstLine) {
                    note.title = firstLine.substring(0, 30);
                }
                renderNotesList();
            }
        }

        function createNewNote() {
            const newNote = {
                id: state.notes.length + 1,
                title: 'New Note',
                content: ''
            };
            state.notes.unshift(newNote);
            loadNote(newNote.id);
        }

        function deleteNote() {
            if (state.notes.length <= 1) return;

            state.notes = state.notes.filter(n => n.id !== state.activeNote);
            loadNote(state.notes[0].id);
        }

        // Settings Functions
        function showSettings(category) {
            const content = document.getElementById('settings-content');

            // Update sidebar active state
            document.querySelectorAll('.settings-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent.toLowerCase().includes(category)) {
                    item.classList.add('active');
                }
            });

            switch (category) {
                case 'appearance':
                    content.innerHTML = `
                        <div class="settings-section">
                            <div class="settings-title">Appearance</div>
                            <div class="setting-row">
                                <div class="setting-label">Dark Mode</div>
                                <div class="toggle-switch ${state.theme === 'dark' ? 'active' : ''}" onclick="toggleTheme()"></div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-label">Accent Color</div>
                                <select class="btn" style="padding: 8px 12px;">
                                    <option>Blue</option>
                                    <option>Purple</option>
                                    <option>Pink</option>
                                    <option>Red</option>
                                    <option>Orange</option>
                                    <option>Yellow</option>
                                    <option>Green</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;

                case 'desktop':
                    content.innerHTML = `
                        <div class="settings-section">
                            <div class="settings-title">Desktop & Screen Saver</div>
                            <div class="setting-row">
                                <div class="setting-label">Show Icons on Desktop</div>
                                <div class="toggle-switch active"></div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-label">Wallpaper</div>
                                <button class="btn">Change...</button>
                            </div>
                        </div>
                    `;
                    break;

                case 'displays':
                    content.innerHTML = `
                        <div class="settings-section">
                            <div class="settings-title">Displays</div>
                            <div class="setting-row">
                                <div class="setting-label">Resolution</div>
                                <select class="btn" style="padding: 8px 12px;">
                                    <option>1920 × 1080</option>
                                    <option>2560 × 1440</option>
                                    <option>3840 × 2160</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-label">Brightness</div>
                                <input type="range" min="0" max="100" value="75" style="flex: 1;">
                            </div>
                        </div>
                    `;
                    break;

                case 'sound':
                    content.innerHTML = `
                        <div class="settings-section">
                            <div class="settings-title">Sound</div>
                            <div class="setting-row">
                                <div class="setting-label">Output Volume</div>
                                <input type="range" min="0" max="100" value="50" style="flex: 1;">
                            </div>
                            <div class="setting-row">
                                <div class="setting-label">Alert Sound</div>
                                <select class="btn" style="padding: 8px 12px;">
                                    <option>Basso</option>
                                    <option>Blow</option>
                                    <option>Bottle</option>
                                    <option>Frog</option>
                                    <option>Funk</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;

                case 'network':
                    content.innerHTML = `
                        <div class="settings-section">
                            <div class="settings-title">Network</div>
                            <div class="setting-row">
                                <div class="setting-label">Wi-Fi</div>
                                <div class="toggle-switch active"></div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-label">Connected to: Home Network</div>
                                <button class="btn">Details...</button>
                            </div>
                        </div>
                    `;
                    break;
            }
        }

        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', state.theme);
            showSettings('appearance');
        }

        // Calendar Functions
        let currentDate = new Date();

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            document.getElementById('calendar-title').textContent =
                new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            // Day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day';

                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    cell.classList.add('today');
                }

                cell.innerHTML = `<div class="calendar-day-number">${day}</div>`;
                grid.appendChild(cell);
            }
        }

        function calendarPrevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function calendarNextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function calendarToday() {
            currentDate = new Date();
            renderCalendar();
        }


        // Spotlight Search
        function toggleSpotlight() {
            const spotlight = document.getElementById('spotlight');
            spotlight.classList.toggle('active');

            if (spotlight.classList.contains('active')) {
                const input = document.getElementById('spotlight-input');
                input.value = '';
                input.focus();
                updateSpotlightResults('');
            }
        }

        document.getElementById('spotlight-input').addEventListener('input', (e) => {
            updateSpotlightResults(e.target.value);
        });

        document.getElementById('spotlight-input').addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                toggleSpotlight();
            } else if (e.key === 'Enter') {
                const results = document.querySelectorAll('.spotlight-result');
                if (results.length > 0) {
                    const selected = document.querySelector('.spotlight-result.selected') || results[0];
                    const appId = selected.getAttribute('data-app');
                    if (appId) {
                        launchApp(appId);
                        toggleSpotlight();
                    }
                }
            }
        });

        function updateSpotlightResults(query) {
            const results = document.getElementById('spotlight-results');

            if (!query) {
                results.innerHTML = '';
                return;
            }

            const searchableApps = Object.values(apps).filter(app =>
                app.name.toLowerCase().includes(query.toLowerCase())
            );

            results.innerHTML = '';
            searchableApps.forEach((app, index) => {
                const div = document.createElement('div');
                div.className = 'spotlight-result' + (index === 0 ? ' selected' : '');
                div.setAttribute('data-app', app.id);
                div.innerHTML = `
                    <div class="spotlight-icon">📦</div>
                    <div>
                        <div style="font-weight: 600;">${app.name}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Application</div>
                    </div>
                `;
                div.onclick = () => {
                    launchApp(app.id);
                    toggleSpotlight();
                };
                results.appendChild(div);
            });
        }

        // Menu Bar Functions
        document.querySelector('.apple-logo').addEventListener('click', (e) => {
            e.stopPropagation();
            const menu = document.getElementById('apple-menu');
            menu.classList.toggle('active');
        });

        document.addEventListener('click', () => {
            document.querySelectorAll('.menu-dropdown').forEach(menu => {
                menu.classList.remove('active');
            });
        });

        function showAboutMac() {
            alert('macOS Simulator v1.0\nBuilt with HTML, CSS, and JavaScript\n\n© 2024 macOS Simulator');
        }

        function systemSleep() {
            alert('Sleep functionality would dim the screen here!');
        }

        function systemRestart() {
            if (confirm('Are you sure you want to restart?')) {
                location.reload();
            }
        }

        function systemShutdown() {
            if (confirm('Are you sure you want to shut down?')) {
                document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: black; color: white; font-size: 24px;">Shutting down...</div>';
            }
        }

        // Clock Update
        function updateClock() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            const displayMinutes = minutes < 10 ? '0' + minutes : minutes;

            document.getElementById('clock').textContent =
                `${displayHours}:${displayMinutes} ${ampm}`;
        }

        setInterval(updateClock, 1000);
        updateClock();

        // Keyboard Shortcuts - PHASE 12
        document.addEventListener('keydown', (e) => {
            const isMac = e.metaKey;
            const isCtrl = e.ctrlKey;
            const cmdKey = isMac || isCtrl;

            // Cmd+Space for Spotlight
            if (cmdKey && e.code === 'Space') {
                e.preventDefault();
                toggleSpotlight();
            }

            // Cmd+Q - Quit active app
            if (cmdKey && e.code === 'KeyQ') {
                e.preventDefault();
                if (state.activeWindow) {
                    WindowManager.closeWindow(state.activeWindow);
                }
            }

            // Cmd+W - Close active window
            if (cmdKey && e.code === 'KeyW') {
                e.preventDefault();
                if (state.activeWindow) {
                    WindowManager.closeWindow(state.activeWindow);
                }
            }

            // Cmd+M - Minimize active window
            if (cmdKey && e.code === 'KeyM') {
                e.preventDefault();
                if (state.activeWindow) {
                    WindowManager.minimizeWindow(state.activeWindow);
                }
            }

            // Cmd+N - New window (context-dependent)
            if (cmdKey && e.code === 'KeyN') {
                e.preventDefault();
                // Open new Finder window
                launchApp('finder');
            }

            // Cmd+T - New tab (Safari)
            if (cmdKey && e.code === 'KeyT') {
                e.preventDefault();
                const activeWin = state.windows.find(w => w.id === state.activeWindow);
                if (activeWin && activeWin.appId === 'safari') {
                    safariNewTab();
                }
            }

            // Cmd+R - Refresh (Safari)
            if (cmdKey && e.code === 'KeyR') {
                e.preventDefault();
                const activeWin = state.windows.find(w => w.id === state.activeWindow);
                if (activeWin && activeWin.appId === 'safari') {
                    safariRefresh();
                }
            }

            // Cmd+Tab - App switcher (simplified)
            if (cmdKey && e.code === 'Tab') {
                e.preventDefault();
                if (state.windows.length > 0) {
                    const currentIndex = state.windows.findIndex(w => w.id === state.activeWindow);
                    const nextIndex = (currentIndex + 1) % state.windows.length;
                    WindowManager.setActiveWindow(state.windows[nextIndex].id);
                }
            }

            // Cmd+H - Hide app
            if (cmdKey && e.code === 'KeyH') {
                e.preventDefault();
                if (state.activeWindow) {
                    WindowManager.minimizeWindow(state.activeWindow);
                }
            }

            // Cmd+, - Open settings (in active app)
            if (cmdKey && e.code === 'Comma') {
                e.preventDefault();
                launchApp('settings');
            }
        });

        // Close spotlight when clicking outside
        document.getElementById('spotlight').addEventListener('click', (e) => {
            if (e.target.id === 'spotlight') {
                toggleSpotlight();
            }
        });

        // ========================================
        // PHASE 1: BOOT, LOGIN & DESKTOP ICONS
        // ========================================

        // Desktop Icons State
        const desktopIcons = [
            { id: 1, name: 'Documents', icon: '📄', x: 20, y: 20 },
            { id: 2, name: 'Projects', icon: '📁', x: 20, y: 140 },
            { id: 3, name: 'Screenshots', icon: '📸', x: 20, y: 260 }
        ];

        let selectedIcon = null;
        let draggingIcon = null;

        // Boot Sequence
        function startBootSequence() {
            const bootScreen = document.getElementById('boot-screen');
            const loginScreen = document.getElementById('login-screen');

            // Hide menu bar and dock initially
            document.getElementById('menu-bar').style.opacity = '0';
            document.getElementById('dock').style.opacity = '0';
            document.getElementById('desktop').style.opacity = '0';

            // Wait for boot animation to complete (3.5s)
            setTimeout(() => {
                bootScreen.classList.add('hidden');

                // Show login screen
                setTimeout(() => {
                    loginScreen.classList.add('active');
                    updateLoginTime();

                    // Auto-focus password field
                    document.getElementById('login-password').focus();
                }, 500);
            }, 3500);
        }

        // Update Login Time
        function updateLoginTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const displayHours = hours % 12 || 12;
            const displayMinutes = minutes < 10 ? '0' + minutes : minutes;

            const timeEl = document.getElementById('login-time');
            const dateEl = document.getElementById('login-date');

            if (timeEl) timeEl.textContent = `${displayHours}:${displayMinutes}`;

            if (dateEl) {
                const options = { weekday: 'long', month: 'long', day: 'numeric' };
                dateEl.textContent = now.toLocaleDateString('en-US', options);
            }
        }

        // Perform Login
        function performLogin() {
            const loginScreen = document.getElementById('login-screen');

            // Fade out login screen
            loginScreen.classList.remove('active');

            setTimeout(() => {
                // Show desktop elements
                document.getElementById('menu-bar').style.opacity = '1';
                document.getElementById('menu-bar').style.transition = 'opacity 0.5s';
                document.getElementById('dock').style.opacity = '1';
                document.getElementById('dock').style.transition = 'opacity 0.5s';
                document.getElementById('desktop').style.opacity = '1';
                document.getElementById('desktop').style.transition = 'opacity 0.5s';

                // Render desktop icons
                renderDesktopIcons();

                // Load saved state
                loadSystemState();
            }, 500);
        }

        // Handle Enter key on login
        document.addEventListener('DOMContentLoaded', () => {
            const loginPassword = document.getElementById('login-password');
            if (loginPassword) {
                loginPassword.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        performLogin();
                    }
                });
            }
        });

        // Desktop Icons Functions
        function renderDesktopIcons() {
            const desktop = document.getElementById('desktop');

            // Clear existing icons
            const existingIcons = desktop.querySelectorAll('.desktop-icon');
            existingIcons.forEach(icon => icon.remove());

            // Render icons
            desktopIcons.forEach(iconData => {
                const icon = createDesktopIcon(iconData);
                desktop.appendChild(icon);
            });
        }

        function createDesktopIcon(data) {
            const icon = document.createElement('div');
            icon.className = 'desktop-icon';
            icon.id = `desktop-icon-${data.id}`;
            icon.style.left = `${data.x}px`;
            icon.style.top = `${data.y}px`;

            icon.innerHTML = `
                <div class="desktop-icon-img">${data.icon}</div>
                <div class="desktop-icon-name">${data.name}</div>
            `;

            // Click to select
            icon.addEventListener('click', (e) => {
                e.stopPropagation();
                selectDesktopIcon(data.id);
            });

            // Double-click to open
            icon.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                alert(`Opening ${data.name}...`);
            });

            // Drag to move
            icon.addEventListener('mousedown', (e) => {
                if (e.button === 0) { // Left click only
                    startDragIcon(data.id, e);
                }
            });

            // Right-click context menu
            icon.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e.clientX, e.clientY, 'icon', data);
            });

            return icon;
        }

        function selectDesktopIcon(id) {
            // Deselect all
            document.querySelectorAll('.desktop-icon').forEach(icon => {
                icon.classList.remove('selected');
            });

            // Select this one
            const icon = document.getElementById(`desktop-icon-${id}`);
            if (icon) {
                icon.classList.add('selected');
                selectedIcon = id;
            }
        }

        function startDragIcon(id, e) {
            draggingIcon = id;
            const icon = document.getElementById(`desktop-icon-${id}`);
            if (!icon) return;

            const rect = icon.getBoundingClientRect();
            const offsetX = e.clientX - rect.left;
            const offsetY = e.clientY - rect.top;

            function onMouseMove(e) {
                if (!draggingIcon) return;

                const desktop = document.getElementById('desktop');
                const desktopRect = desktop.getBoundingClientRect();

                let x = e.clientX - desktopRect.left - offsetX;
                let y = e.clientY - desktopRect.top - offsetY;

                // Constrain to desktop bounds
                x = Math.max(0, Math.min(x, desktopRect.width - 80));
                y = Math.max(0, Math.min(y, desktopRect.height - 100));

                icon.style.left = `${x}px`;
                icon.style.top = `${y}px`;

                // Update data
                const iconData = desktopIcons.find(i => i.id === draggingIcon);
                if (iconData) {
                    iconData.x = x;
                    iconData.y = y;
                }
            }

            function onMouseUp() {
                draggingIcon = null;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                saveSystemState();
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        // Deselect icon when clicking desktop
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('desktop').addEventListener('click', () => {
                document.querySelectorAll('.desktop-icon').forEach(icon => {
                    icon.classList.remove('selected');
                });
                selectedIcon = null;
            });

            // Desktop right-click
            document.getElementById('desktop').addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e.clientX, e.clientY, 'desktop');
            });
        });

        // Context Menu
        function showContextMenu(x, y, type, data = null) {
            const menu = document.getElementById('context-menu');

            let menuItems = '';

            if (type === 'desktop') {
                menuItems = `
                    <div class="context-menu-item" onclick="createNewFolder()">
                        New Folder
                    </div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item" onclick="hideContextMenu()">
                        Get Info<span class="context-menu-shortcut">⌘I</span>
                    </div>
                    <div class="context-menu-item" onclick="hideContextMenu()">
                        Change Desktop Background...
                    </div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item" onclick="hideContextMenu()">
                        Use Stacks
                    </div>
                    <div class="context-menu-item" onclick="hideContextMenu()">
                        Sort By
                    </div>
                `;
            } else if (type === 'icon') {
                menuItems = `
                    <div class="context-menu-item" onclick="hideContextMenu()">
                        Open
                    </div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item" onclick="hideContextMenu()">
                        Get Info<span class="context-menu-shortcut">⌘I</span>
                    </div>
                    <div class="context-menu-item" onclick="renameIcon(${data.id})">
                        Rename
                    </div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item" onclick="deleteIcon(${data.id})">
                        Move to Trash<span class="context-menu-shortcut">⌘⌫</span>
                    </div>
                `;
            }

            menu.innerHTML = menuItems;
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.classList.add('active');

            // Close on click elsewhere
            setTimeout(() => {
                document.addEventListener('click', hideContextMenu, { once: true });
            }, 100);
        }

        function hideContextMenu() {
            const menu = document.getElementById('context-menu');
            menu.classList.remove('active');
        }

        function createNewFolder() {
            const newIcon = {
                id: desktopIcons.length + 1,
                name: 'Untitled Folder',
                icon: '📁',
                x: 20,
                y: 20 + desktopIcons.length * 120
            };
            desktopIcons.push(newIcon);
            renderDesktopIcons();
            saveSystemState();
            hideContextMenu();
        }

        function renameIcon(id) {
            const iconData = desktopIcons.find(i => i.id === id);
            if (iconData) {
                const newName = prompt('Enter new name:', iconData.name);
                if (newName && newName.trim()) {
                    iconData.name = newName.trim();
                    renderDesktopIcons();
                    saveSystemState();
                }
            }
            hideContextMenu();
        }

        function deleteIcon(id) {
            const index = desktopIcons.findIndex(i => i.id === id);
            if (index > -1) {
                desktopIcons.splice(index, 1);
                renderDesktopIcons();
                saveSystemState();
            }
            hideContextMenu();
        }

        // ========================================
        // ENHANCED WINDOW MANAGEMENT
        // ========================================

        // Update WindowManager for improved functionality
        const originalCreateWindow = WindowManager.createWindow;
        WindowManager.createWindow = function(app) {
            const windowId = originalCreateWindow.call(this, app);
            const window = document.getElementById(windowId);

            if (!window) return windowId;

            // Add minimum size constraints
            window.style.minWidth = '320px';
            window.style.minHeight = '200px';

            // Double-click titlebar to maximize
            const titlebar = window.querySelector('.window-titlebar');
            titlebar.addEventListener('dblclick', (e) => {
                if (!e.target.classList.contains('traffic-light')) {
                    WindowManager.toggleMaximize(windowId);
                }
            });

            // Store original position/size for restore
            if (!window.dataset.originalSize) {
                window.dataset.originalSize = JSON.stringify({
                    width: window.style.width,
                    height: window.style.height,
                    left: window.style.left,
                    top: window.style.top
                });
            }

            return windowId;
        };

        // Improved minimize with dock animation
        const originalMinimize = WindowManager.minimizeWindow;
        WindowManager.minimizeWindow = function(windowId) {
            const window = document.getElementById(windowId);
            if (!window) return;

            // Get dock icon position
            const windowData = state.windows.find(w => w.id === windowId);
            if (!windowData) return;

            const dockItem = document.querySelector(`.dock-item[data-app="${windowData.appId}"]`);

            if (dockItem) {
                const windowRect = window.getBoundingClientRect();
                const dockRect = dockItem.getBoundingClientRect();

                // Calculate transform
                const scaleX = dockRect.width / windowRect.width;
                const scaleY = dockRect.height / windowRect.height;
                const translateX = dockRect.left - windowRect.left;
                const translateY = dockRect.top - windowRect.top;

                // Animate to dock
                window.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                window.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scaleX}, ${scaleY})`;
                window.style.opacity = '0';

                setTimeout(() => {
                    window.style.transition = '';
                    window.style.transform = '';
                    window.style.opacity = '';
                    window.classList.add('minimized');

                    // Add minimized indicator to dock
                    dockItem.classList.add('has-minimized');
                }, 400);
            } else {
                originalMinimize.call(this, windowId);
            }
        };

        // Restore minimized window
        WindowManager.restoreWindow = function(windowId) {
            const window = document.getElementById(windowId);
            if (!window) return;

            window.classList.remove('minimized');
            this.setActiveWindow(windowId);

            const windowData = state.windows.find(w => w.id === windowId);
            if (windowData) {
                const dockItem = document.querySelector(`.dock-item[data-app="${windowData.appId}"]`);
                if (dockItem) {
                    dockItem.classList.remove('has-minimized');
                }
            }
        };

        // Update dock click to restore minimized windows
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.dock-item[data-app]').forEach(item => {
                const originalOnClick = item.getAttribute('onclick');
                item.removeAttribute('onclick');

                item.addEventListener('click', () => {
                    const appId = item.getAttribute('data-app');
                    const existingWindow = state.windows.find(w => w.appId === appId);

                    if (existingWindow) {
                        if (existingWindow.element.classList.contains('minimized')) {
                            WindowManager.restoreWindow(existingWindow.id);
                        } else {
                            WindowManager.setActiveWindow(existingWindow.id);
                        }
                    } else {
                        launchApp(appId);
                    }
                });
            });
        });

        // ========================================
        // LOCALSTORAGE PERSISTENCE
        // ========================================

        function saveSystemState() {
            const stateToSave = {
                desktopIcons: desktopIcons,
                theme: state.theme,
                notes: state.notes,
                timestamp: Date.now()
            };

            try {
                localStorage.setItem('macos-simulator-state', JSON.stringify(stateToSave));
            } catch (e) {
                console.warn('Failed to save state:', e);
            }
        }

        function loadSystemState() {
            try {
                const saved = localStorage.getItem('macos-simulator-state');
                if (saved) {
                    const data = JSON.parse(saved);

                    // Restore desktop icons
                    if (data.desktopIcons) {
                        desktopIcons.length = 0;
                        desktopIcons.push(...data.desktopIcons);
                        renderDesktopIcons();
                    }

                    // Restore theme
                    if (data.theme) {
                        state.theme = data.theme;
                        document.body.setAttribute('data-theme', data.theme);
                    }

                    // Restore notes
                    if (data.notes) {
                        state.notes = data.notes;
                    }
                }
            } catch (e) {
                console.warn('Failed to load state:', e);
            }
        }

        // ========================================
        // NEW APPS IMPLEMENTATION - PHASE 3-10
        // ========================================

        // MUSIC APP FUNCTIONS
        const musicTracks = [
            {
                title: "Winston Churchill - Be Ye Men of Valour",
                artist: "Archive.org Public Domain",
                url: "https://archive.org/download/Greatest_Speeches_of_the_20th_Century/Winston_Churchill_-_Be_Ye_Men_of_Valour.mp3",
                artwork: "https://source.unsplash.com/random/300x300?speech,winston,churchill"
            },
            {
                title: "Classical Piano",
                artist: "Public Domain",
                url: "https://archive.org/download/AOC11B/onclassical_luisi_bach_partita_1_bwv_825_1_prelude.mp3",
                artwork: "https://source.unsplash.com/random/300x300?piano,classical"
            },
            {
                title: "Mozart Symphony",
                artist: "Public Domain",
                url: "https://archive.org/download/Mozart_Sy mphonies_HvK/01-40-1.mp3",
                artwork: "https://source.unsplash.com/random/300x300?orchestra,mozart"
            },
            {
                title: "Jazz Standards",
                artist: "Archive.org",
                url: "https://archive.org/download/78_avalon_the-benny-goodman-sextet-charlie-christian-goodman-hamp_gbia0001893a/01%20-%20Avalon%20-%20The%20Benny%20Goodman%20Sextet-restored.mp3",
                artwork: "https://source.unsplash.com/random/300x300?jazz,music"
            },
            {
                title: "Blues Guitar",
                artist: "Public Domain",
                url: "https://archive.org/download/GoldMedalBlues/01DeadShrimp.mp3",
                artwork: "https://source.unsplash.com/random/300x300?guitar,blues"
            },
            {
                title: "Beethoven Symphony",
                artist: "Classical",
                url: "https://archive.org/download/beethovensymphon01beet/beethovensymphon01beet_01_beethoven_64kb.mp3",
                artwork: "https://source.unsplash.com/random/300x300?beethoven,symphony"
            }
        ];

        let currentTrackIndex = 0;
        let audioPlayer = null;

        function initMusic() {
            audioPlayer = document.getElementById('audio-player');
            const grid = document.getElementById('music-grid');

            grid.innerHTML = musicTracks.map((track, index) => `
                <div class="music-item" onclick="playTrack(${index})">
                    <img src="${track.artwork}" alt="${track.title}">
                    <div class="music-item-title">${track.title}</div>
                    <div class="music-item-artist">${track.artist}</div>
                </div>
            `).join('');

            // Set up audio player events
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', nextTrack);
            audioPlayer.volume = 0.8;
        }

        function playTrack(index) {
            currentTrackIndex = index;
            const track = musicTracks[index];

            audioPlayer.src = track.url;
            audioPlayer.play();

            document.getElementById('player-title').textContent = track.title;
            document.getElementById('player-artist').textContent = track.artist;
            document.getElementById('player-artwork').src = track.artwork;
            document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
        }

        function togglePlay() {
            if (audioPlayer.paused) {
                audioPlayer.play();
                document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
            } else {
                audioPlayer.pause();
                document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-play"></i>';
            }
        }

        function nextTrack() {
            currentTrackIndex = (currentTrackIndex + 1) % musicTracks.length;
            playTrack(currentTrackIndex);
        }

        function previousTrack() {
            currentTrackIndex = (currentTrackIndex - 1 + musicTracks.length) % musicTracks.length;
            playTrack(currentTrackIndex);
        }

        function updateProgress() {
            if (audioPlayer.duration) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                document.getElementById('progress-bar').value = progress;
                document.getElementById('current-time').textContent = formatTime(audioPlayer.currentTime);
                document.getElementById('duration').textContent = formatTime(audioPlayer.duration);
            }
        }

        function seekAudio(value) {
            const time = (value / 100) * audioPlayer.duration;
            audioPlayer.currentTime = time;
        }

        function setVolume(value) {
            audioPlayer.volume = value / 100;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function switchMusicView(view) {
            // For future implementation of playlists
        }

        // PHOTOS APP FUNCTIONS
        let currentPhotoIndex = 0;
        let currentPhotosCategory = 'all';
        let slideshowInterval = null;

        function initPhotos() {
            loadPhotos('all');
        }

        function loadPhotos(category) {
            currentPhotosCategory = category;
            const grid = document.getElementById('photos-grid');
            const count = 20;

            document.getElementById('photos-title').textContent = category === 'all' ? 'All Photos' : category.charAt(0).toUpperCase() + category.slice(1);

            // Update active nav item
            document.querySelectorAll('.photos-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');

            grid.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-item';
                photoDiv.onclick = () => viewPhoto(i);
                photoDiv.innerHTML = `<img src="https://source.unsplash.com/random/400x400?${category},${i}" alt="Photo ${i}">`;
                grid.appendChild(photoDiv);
            }
        }

        function switchPhotosView(category) {
            loadPhotos(category);
        }

        function viewPhoto(index) {
            currentPhotoIndex = index;
            const viewer = document.getElementById('photo-viewer');
            const img = document.getElementById('viewer-image');
            img.src = `https://source.unsplash.com/random/1200x800?${currentPhotosCategory},${index}`;
            viewer.style.display = 'flex';
        }

        function closePhotoViewer() {
            document.getElementById('photo-viewer').style.display = 'none';
            stopSlideshow();
        }

        function nextPhoto() {
            currentPhotoIndex = (currentPhotoIndex + 1) % 20;
            document.getElementById('viewer-image').src = `https://source.unsplash.com/random/1200x800?${currentPhotosCategory},${currentPhotoIndex}`;
        }

        function prevPhoto() {
            currentPhotoIndex = (currentPhotoIndex - 1 + 20) % 20;
            document.getElementById('viewer-image').src = `https://source.unsplash.com/random/1200x800?${currentPhotosCategory},${currentPhotoIndex}`;
        }

        function startSlideshow() {
            viewPhoto(0);
            slideshowInterval = setInterval(nextPhoto, 3000);
        }

        function stopSlideshow() {
            if (slideshowInterval) {
                clearInterval(slideshowInterval);
                slideshowInterval = null;
            }
        }

        // MAPS APP FUNCTIONS
        let map = null;
        let markers = [];

        function initMap() {
            // Wait for Leaflet to load
            setTimeout(() => {
                if (typeof L !== 'undefined') {
                    map = L.map('map').setView([37.7749, -122.4194], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);

                    // Add initial marker
                    const marker = L.marker([37.7749, -122.4194]).addTo(map);
                    marker.bindPopup('San Francisco, CA').openPopup();
                    markers.push(marker);
                } else {
                    console.error('Leaflet not loaded');
                }
            }, 100);
        }

        async function searchLocation() {
            const query = document.getElementById('maps-search').value;
            if (!query) return;

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const { lat, lon, display_name } = data[0];
                    map.setView([lat, lon], 13);

                    // Clear old markers
                    markers.forEach(m => map.removeLayer(m));
                    markers = [];

                    // Add new marker
                    const marker = L.marker([lat, lon]).addTo(map);
                    marker.bindPopup(display_name).openPopup();
                    markers.push(marker);
                }
            } catch (error) {
                console.error('Search error:', error);
                alert('Failed to search location. Please try again.');
            }
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const { latitude, longitude } = position.coords;
                    map.setView([latitude, longitude], 13);

                    const marker = L.marker([latitude, longitude]).addTo(map);
                    marker.bindPopup('Your Location').openPopup();
                    markers.push(marker);
                }, () => {
                    alert('Unable to get your location');
                });
            }
        }

        // WEATHER APP FUNCTIONS
        async function fetchWeather() {
            const city = document.getElementById('weather-city').value || 'San Francisco';
            const content = document.getElementById('weather-content');

            content.innerHTML = '<div class="weather-loading">Loading weather data...</div>';

            try {
                const response = await fetch(`https://wttr.in/${encodeURIComponent(city)}?format=j1`);
                const data = await response.json();

                const current = data.current_condition[0];
                const weather = data.weather[0];

                content.innerHTML = `
                    <div class="weather-main">
                        <h2>${data.nearest_area[0].areaName[0].value}, ${data.nearest_area[0].country[0].value}</h2>
                        <div class="weather-temp">${current.temp_F}°F</div>
                        <div class="weather-desc">${current.weatherDesc[0].value}</div>
                        <p>Feels like ${current.FeelsLikeF}°F</p>
                    </div>
                    <div class="weather-details">
                        <div class="weather-detail-item">
                            <h4>Humidity</h4>
                            <p>${current.humidity}%</p>
                        </div>
                        <div class="weather-detail-item">
                            <h4>Wind Speed</h4>
                            <p>${current.windspeedMiles} mph</p>
                        </div>
                        <div class="weather-detail-item">
                            <h4>Pressure</h4>
                            <p>${current.pressure} mb</p>
                        </div>
                        <div class="weather-detail-item">
                            <h4>Visibility</h4>
                            <p>${current.visibility} mi</p>
                        </div>
                        <div class="weather-detail-item">
                            <h4>UV Index</h4>
                            <p>${current.uvIndex}</p>
                        </div>
                        <div class="weather-detail-item">
                            <h4>High / Low</h4>
                            <p>${weather.maxtempF}° / ${weather.mintempF}°</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `
                    <div class="weather-main">
                        <h2>Error Loading Weather</h2>
                        <p>Unable to fetch weather data for "${city}"</p>
                        <p>Please try a different city or check your connection.</p>
                    </div>
                `;
            }
        }

        // STOCKS APP FUNCTIONS
        const stockSymbols = ['AAPL', 'GOOGL', 'MSFT', 'AMZN', 'TSLA'];
        let stockChart = null;

        async function initStocks() {
            await loadStocks();
            createStockChart();
        }

        async function loadStocks() {
            const list = document.getElementById('stocks-list');
            list.innerHTML = '<div class="stocks-loading">Loading stock data...</div>';

            // Simulated stock data (Yahoo Finance API has CORS issues)
            const stockData = [
                { symbol: 'AAPL', name: 'Apple Inc.', price: 178.42, change: 2.34, changePercent: 1.33 },
                { symbol: 'GOOGL', name: 'Alphabet Inc.', price: 138.21, change: -1.23, changePercent: -0.88 },
                { symbol: 'MSFT', name: 'Microsoft Corp.', price: 378.91, change: 5.67, changePercent: 1.52 },
                { symbol: 'AMZN', name: 'Amazon.com Inc.', price: 145.32, change: 3.21, changePercent: 2.26 },
                { symbol: 'TSLA', name: 'Tesla Inc.', price: 242.84, change: -4.56, changePercent: -1.84 }
            ];

            list.innerHTML = stockData.map(stock => `
                <div class="stock-item">
                    <div class="stock-info">
                        <h3>${stock.symbol}</h3>
                        <p>${stock.name}</p>
                    </div>
                    <div class="stock-price">
                        <div class="stock-price-value">$${stock.price.toFixed(2)}</div>
                        <div class="stock-change ${stock.change >= 0 ? 'positive' : 'negative'}">
                            ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function createStockChart() {
            const canvas = document.getElementById('stocks-chart-canvas');
            if (!canvas || typeof Chart === 'undefined') return;

            const ctx = canvas.getContext('2d');
            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['9:30', '10:00', '11:00', '12:00', '1:00', '2:00', '3:00', '4:00'],
                    datasets: [{
                        label: 'Portfolio Value',
                        data: [10000, 10150, 10230, 10180, 10320, 10420, 10380, 10510],
                        borderColor: '#007AFF',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function refreshStocks() {
            loadStocks();
        }

        // NEWS APP FUNCTIONS
        function initNews() {
            loadNews();
        }

        async function loadNews() {
            const content = document.getElementById('news-content');
            content.innerHTML = '<div class="news-loading">Loading news...</div>';

            // Simulated news data (NewsAPI requires key)
            const newsData = [
                {
                    title: "Tech Giants Announce New AI Initiatives",
                    description: "Major technology companies have unveiled their latest artificial intelligence projects, promising significant advancements in machine learning capabilities.",
                    source: "Tech News Daily",
                    publishedAt: new Date().toLocaleDateString()
                },
                {
                    title: "Global Markets Show Strong Performance",
                    description: "Stock markets around the world have shown robust growth, with tech stocks leading the rally amid positive economic indicators.",
                    source: "Financial Times",
                    publishedAt: new Date().toLocaleDateString()
                },
                {
                    title: "New Space Mission Launched Successfully",
                    description: "NASA and SpaceX successfully launched a new mission to explore the outer reaches of our solar system, marking a milestone in space exploration.",
                    source: "Space News",
                    publishedAt: new Date().toLocaleDateString()
                },
                {
                    title: "Climate Summit Reaches Historic Agreement",
                    description: "World leaders have reached a landmark agreement on climate action, committing to ambitious carbon reduction targets.",
                    source: "Environment Today",
                    publishedAt: new Date().toLocaleDateString()
                },
                {
                    title: "Breakthrough in Medical Research",
                    description: "Scientists announce a significant breakthrough in treating a previously incurable disease, offering hope to millions of patients worldwide.",
                    source: "Medical Journal",
                    publishedAt: new Date().toLocaleDateString()
                }
            ];

            content.innerHTML = newsData.map(article => `
                <div class="news-item" onclick="window.open('https://news.google.com', '_blank')">
                    <h3>${article.title}</h3>
                    <p>${article.description}</p>
                    <div class="news-meta">${article.source} • ${article.publishedAt}</div>
                </div>
            `).join('');
        }

        function refreshNews() {
            loadNews();
        }

        // VIDEOS APP FUNCTIONS
        const videoLibrary = [
            {
                title: "Big Buck Bunny",
                url: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4",
                thumbnail: "https://source.unsplash.com/random/400x225?bunny,animation",
                duration: "9:56"
            },
            {
                title: "Elephants Dream",
                url: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4",
                thumbnail: "https://source.unsplash.com/random/400x225?elephant,dream",
                duration: "10:53"
            },
            {
                title: "For Bigger Blazes",
                url: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4",
                thumbnail: "https://source.unsplash.com/random/400x225?fire,nature",
                duration: "0:15"
            },
            {
                title: "Sintel Movie",
                url: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4",
                thumbnail: "https://source.unsplash.com/random/400x225?dragon,fantasy",
                duration: "14:48"
            }
        ];

        function initVideos() {
            const library = document.getElementById('videos-library');
            library.innerHTML = videoLibrary.map((video, index) => `
                <div class="video-thumb" onclick="playVideo(${index})">
                    <img src="${video.thumbnail}" alt="${video.title}">
                    <div class="video-thumb-info">
                        <div class="video-thumb-title">${video.title}</div>
                        <div class="video-thumb-duration">${video.duration}</div>
                    </div>
                </div>
            `).join('');
        }

        function playVideo(index) {
            const video = videoLibrary[index];
            const player = document.getElementById('video-player');
            player.src = video.url;
            player.play();

            document.getElementById('videos-library').style.display = 'none';
            document.getElementById('video-player-container').style.display = 'flex';
        }

        function closeVideoPlayer() {
            const player = document.getElementById('video-player');
            player.pause();
            player.src = '';

            document.getElementById('videos-library').style.display = 'grid';
            document.getElementById('video-player-container').style.display = 'none';
        }

        // ========================================
        // SAFARI UPDATE FOR REAL BROWSING - PHASE 2
        // ========================================

        function renderSafariContent() {
            const activeTab = state.safari.tabs.find(t => t.active);
            if (!activeTab) return;

            const content = document.getElementById('safari-content');
            const url = activeTab.url;

            // Update address bar
            const addressBar = document.getElementById('address-bar');
            if (addressBar) addressBar.value = url;

            // Try to load in iframe
            content.innerHTML = `
                <div style="position: relative; width: 100%; height: 100%;">
                    <iframe src="${url}"
                            style="width: 100%; height: 100%; border: none;"
                            sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-popups-to-escape-sandbox"
                            onerror="handleIframeError('${url}')">
                    </iframe>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                background: var(--bg-secondary); padding: 40px; border-radius: 12px; text-align: center;
                                display: none;" id="iframe-error-${activeTab.id}">
                        <h2>Cannot Display Page</h2>
                        <p>This website cannot be embedded due to security restrictions.</p>
                        <a href="${url}" target="_blank" style="display: inline-block; margin-top: 20px;
                           padding: 10px 20px; background: var(--macos-blue); color: white;
                           text-decoration: none; border-radius: 8px;">Open in New Tab →</a>
                    </div>
                </div>
            `;

            // Check if iframe loaded after a delay
            setTimeout(() => {
                try {
                    const iframe = content.querySelector('iframe');
                    if (iframe && !iframe.contentWindow.location.href) {
                        throw new Error('Cannot access iframe');
                    }
                } catch (e) {
                    // Show error message
                    const errorDiv = document.getElementById(`iframe-error-${activeTab.id}`);
                    if (errorDiv) errorDiv.style.display = 'block';
                }
            }, 2000);
        }

        function handleIframeError(url) {
            console.warn('Failed to load:', url);
        }

        // Save state periodically
        setInterval(saveSystemState, 30000); // Every 30 seconds

        // Save on unload
        window.addEventListener('beforeunload', saveSystemState);

        // Initialize
        console.log('macOS Simulator v2.0 loaded successfully!');
        console.log('Starting boot sequence...');

        // Start boot sequence on load
        window.addEventListener('load', () => {
            startBootSequence();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>macOS Simulator</title>
    <style>
        /* CSS Variables */
        :root {
            --macos-blue: #007AFF;
            --menu-bar-height: 24px;
            --dock-height: 70px;
            --window-shadow: 0 10px 50px rgba(0,0,0,0.3);
            --border-radius: 10px;
            --transition-speed: 0.3s;
            --blur-amount: 20px;

            /* Light mode colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --border-color: #d2d2d7;
            --menu-bg: rgba(255, 255, 255, 0.8);
            --dock-bg: rgba(255, 255, 255, 0.3);
        }

        [data-theme="dark"] {
            --bg-primary: #1e1e1e;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #a1a1a6;
            --border-color: #3d3d3d;
            --menu-bg: rgba(30, 30, 30, 0.8);
            --dock-bg: rgba(30, 30, 30, 0.3);
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
        }

        /* Desktop */
        #desktop {
            position: absolute;
            top: var(--menu-bar-height);
            left: 0;
            right: 0;
            bottom: var(--dock-height);
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="1920" height="1080"><defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23667eea"/><stop offset="100%" style="stop-color:%23764ba2"/></linearGradient></defs><rect width="1920" height="1080" fill="url(%23g)"/></svg>');
            background-size: cover;
            background-position: center;
        }

        /* Menu Bar */
        #menu-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: var(--menu-bar-height);
            background: var(--menu-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            font-size: 13px;
            font-weight: 500;
            z-index: 10000;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .menu-left, .menu-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-item {
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 4px;
            position: relative;
            transition: background 0.15s;
        }

        .menu-item:hover {
            background: rgba(0,0,0,0.1);
        }

        .apple-logo {
            font-size: 16px;
        }

        .menu-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--menu-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border: 1px solid var(--border-color);
            border-radius: 6px;
            min-width: 200px;
            padding: 4px;
            margin-top: 4px;
            display: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 10001;
        }

        .menu-dropdown.active {
            display: block;
        }

        .dropdown-item {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.1s;
        }

        .dropdown-item:hover {
            background: var(--macos-blue);
            color: white;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        #clock {
            font-variant-numeric: tabular-nums;
        }

        /* Dock */
        #dock {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dock-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 5px 15px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            z-index: 9999;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }

        .dock-item {
            width: 50px;
            height: 50px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border-radius: 10px;
        }

        .dock-item:hover {
            transform: translateY(-10px) scale(1.2);
        }

        .dock-item.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: var(--text-primary);
            border-radius: 50%;
        }

        .dock-divider {
            width: 1px;
            height: 50px;
            background: rgba(255,255,255,0.3);
            margin: 0 5px;
        }

        /* Windows Container */
        #windows-container {
            position: absolute;
            top: var(--menu-bar-height);
            left: 0;
            right: 0;
            bottom: var(--dock-height);
            pointer-events: none;
        }

        /* Window */
        .window {
            position: absolute;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            box-shadow: var(--window-shadow);
            overflow: hidden;
            pointer-events: all;
            display: flex;
            flex-direction: column;
        }

        .window.minimized {
            display: none;
        }

        .window.maximized {
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            border-radius: 0;
        }

        .window-titlebar {
            height: 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            cursor: move;
            user-select: none;
        }

        .traffic-lights {
            display: flex;
            gap: 8px;
            margin-right: auto;
        }

        .traffic-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            transition: filter 0.15s;
        }

        .traffic-light:hover {
            filter: brightness(1.2);
        }

        .traffic-light.close { background: #ff5f57; }
        .traffic-light.minimize { background: #ffbd2e; }
        .traffic-light.maximize { background: #28c840; }

        .traffic-light:hover::before {
            position: absolute;
            font-size: 8px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(0,0,0,0.5);
        }

        .traffic-light.close:hover::before { content: '×'; font-size: 12px; }
        .traffic-light.minimize:hover::before { content: '−'; }
        .traffic-light.maximize:hover::before { content: '+'; }

        .window-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            font-weight: 600;
        }

        .window-content {
            flex: 1;
            overflow: auto;
            background: var(--bg-primary);
        }

        .window-toolbar {
            height: 48px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
        }

        /* Resize handles */
        .resize-handle {
            position: absolute;
            z-index: 10;
        }

        .resize-n { top: 0; left: 0; right: 0; height: 5px; cursor: ns-resize; }
        .resize-s { bottom: 0; left: 0; right: 0; height: 5px; cursor: ns-resize; }
        .resize-e { top: 0; right: 0; bottom: 0; width: 5px; cursor: ew-resize; }
        .resize-w { top: 0; left: 0; bottom: 0; width: 5px; cursor: ew-resize; }
        .resize-ne { top: 0; right: 0; width: 10px; height: 10px; cursor: nesw-resize; }
        .resize-nw { top: 0; left: 0; width: 10px; height: 10px; cursor: nwse-resize; }
        .resize-se { bottom: 0; right: 0; width: 10px; height: 10px; cursor: nwse-resize; }
        .resize-sw { bottom: 0; left: 0; width: 10px; height: 10px; cursor: nesw-resize; }

        /* Finder Styles */
        .finder-container {
            display: flex;
            height: 100%;
        }

        .finder-sidebar {
            width: 180px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px 10px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            padding: 0 8px;
            margin-bottom: 5px;
        }

        .sidebar-item {
            padding: 5px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .sidebar-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .finder-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .finder-items {
            flex: 1;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 20px;
            align-content: start;
            overflow-y: auto;
        }

        .finder-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.15s;
        }

        .finder-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .finder-item.selected {
            background: var(--macos-blue);
            color: white;
        }

        .finder-icon {
            width: 64px;
            height: 64px;
            background: var(--macos-blue);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .finder-name {
            font-size: 12px;
            text-align: center;
            word-break: break-word;
        }

        .finder-statusbar {
            height: 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Safari Styles */
        .safari-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .safari-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 8px 0 8px;
            gap: 2px;
        }

        .safari-tab {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            padding: 6px 30px 6px 12px;
            cursor: pointer;
            font-size: 12px;
            min-width: 120px;
            max-width: 200px;
            position: relative;
            transition: background 0.15s;
        }

        .safari-tab:not(.active) {
            background: var(--bg-secondary);
        }

        .safari-tab:hover {
            background: var(--bg-primary);
        }

        .safari-tab .close-tab {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            opacity: 0;
            background: rgba(0,0,0,0.1);
        }

        .safari-tab:hover .close-tab {
            opacity: 1;
        }

        .safari-tab .close-tab:hover {
            background: rgba(0,0,0,0.2);
        }

        .new-tab-btn {
            padding: 6px 12px;
            cursor: pointer;
            background: transparent;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .new-tab-btn:hover {
            background: rgba(0,0,0,0.05);
        }

        .safari-navigation {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            gap: 8px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .nav-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: background 0.15s;
        }

        .nav-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .address-bar {
            flex: 1;
            height: 28px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0 12px;
            background: var(--bg-primary);
            font-size: 13px;
            outline: none;
        }

        .address-bar:focus {
            border-color: var(--macos-blue);
        }

        .safari-content {
            flex: 1;
            background: var(--bg-primary);
            overflow-y: auto;
            padding: 20px;
        }

        /* Terminal Styles */
        .terminal-container {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            padding: 15px;
            height: 100%;
            overflow-y: auto;
        }

        .terminal-line {
            margin: 2px 0;
            line-height: 1.5;
        }

        .terminal-prompt {
            color: #00ff00;
        }

        .terminal-input-line {
            display: flex;
            align-items: center;
        }

        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #00ff00;
            font-family: inherit;
            font-size: inherit;
            caret-color: #00ff00;
        }

        /* Calculator Styles */
        .calculator-container {
            background: var(--bg-primary);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .calc-display {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            text-align: right;
            font-size: 48px;
            font-weight: 300;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            word-break: break-all;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .calc-btn {
            height: 60px;
            border: none;
            border-radius: 8px;
            font-size: 24px;
            cursor: pointer;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.15s;
        }

        .calc-btn:hover {
            filter: brightness(0.95);
        }

        .calc-btn:active {
            transform: scale(0.95);
        }

        .calc-btn.operator {
            background: var(--macos-blue);
            color: white;
        }

        .calc-btn.function {
            background: #ff9500;
            color: white;
        }

        /* Notes Styles */
        .notes-container {
            display: flex;
            height: 100%;
        }

        .notes-sidebar {
            width: 200px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .notes-list {
            padding: 10px;
        }

        .note-item {
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 5px;
            transition: background 0.15s;
        }

        .note-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .note-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .note-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .note-preview {
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .note-item.active .note-preview {
            color: rgba(255,255,255,0.8);
        }

        .notes-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .notes-content {
            flex: 1;
            padding: 20px;
            border: none;
            outline: none;
            font-size: 15px;
            line-height: 1.6;
            resize: none;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Settings Styles */
        .settings-container {
            display: flex;
            height: 100%;
        }

        .settings-sidebar {
            width: 200px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px 10px;
        }

        .settings-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-bottom: 5px;
            transition: background 0.15s;
        }

        .settings-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .settings-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .settings-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-label {
            font-size: 14px;
        }

        .toggle-switch {
            width: 50px;
            height: 28px;
            background: var(--border-color);
            border-radius: 14px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--macos-blue);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 24px;
        }

        /* Spotlight Styles */
        .spotlight-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 20vh;
            z-index: 20000;
        }

        .spotlight-overlay.active {
            display: flex;
        }

        .spotlight-search {
            background: var(--bg-primary);
            border-radius: 12px;
            width: 600px;
            max-width: 90vw;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .spotlight-input {
            width: 100%;
            padding: 20px;
            border: none;
            outline: none;
            font-size: 32px;
            background: transparent;
            color: var(--text-primary);
        }

        .spotlight-results {
            max-height: 400px;
            overflow-y: auto;
            border-top: 1px solid var(--border-color);
        }

        .spotlight-result {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.15s;
        }

        .spotlight-result:hover,
        .spotlight-result.selected {
            background: var(--macos-blue);
            color: white;
        }

        .spotlight-icon {
            width: 32px;
            height: 32px;
            background: var(--macos-blue);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .spotlight-result:hover .spotlight-icon,
        .spotlight-result.selected .spotlight-icon {
            background: rgba(255,255,255,0.2);
        }

        /* Calendar Styles */
        .calendar-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .calendar-title {
            font-size: 24px;
            font-weight: 600;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            flex: 1;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            color: var(--text-secondary);
            padding: 10px;
        }

        .calendar-day {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.15s;
            min-height: 80px;
        }

        .calendar-day:hover {
            background: rgba(0,122,255,0.1);
            border-color: var(--macos-blue);
        }

        .calendar-day.today {
            background: var(--macos-blue);
            color: white;
            border-color: var(--macos-blue);
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        /* Mail Styles */
        .mail-container {
            display: flex;
            height: 100%;
        }

        .mail-sidebar {
            width: 180px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px 10px;
        }

        .mail-list {
            width: 300px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .mail-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.15s;
        }

        .mail-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .mail-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .mail-sender {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .mail-subject {
            font-size: 13px;
            margin-bottom: 3px;
        }

        .mail-preview {
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mail-item.active .mail-preview {
            color: rgba(255,255,255,0.8);
        }

        .mail-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .mail-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .mail-header-subject {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .mail-header-from {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .mail-body {
            line-height: 1.6;
        }

        /* Button Styles */
        .btn {
            padding: 6px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s;
        }

        .btn:hover {
            background: var(--bg-secondary);
        }

        .btn-primary {
            background: var(--macos-blue);
            color: white;
            border-color: var(--macos-blue);
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        /* Utility Classes */
        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 8px;
        }

        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }

        /* Animations */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .bounce {
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Messages App Styles */
        .messages-container {
            display: flex;
            height: 100%;
        }

        .messages-sidebar {
            width: 200px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .conversation-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.15s;
        }

        .conversation-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .conversation-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--macos-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 5px;
        }

        .conversation-name {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 3px;
        }

        .conversation-preview {
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-item.active .conversation-preview {
            color: rgba(255,255,255,0.8);
        }

        .messages-thread {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .messages-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 14px;
        }

        .messages-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message-bubble {
            max-width: 60%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }

        .message-sent {
            align-self: flex-end;
            background: #007AFF;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-received {
            align-self: flex-start;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 3px;
        }

        .messages-input-container {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .messages-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            outline: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .messages-send-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: var(--macos-blue);
            color: white;
            cursor: pointer;
            font-weight: 500;
        }

        .messages-send-btn:hover {
            filter: brightness(1.1);
        }

        /* Reminders App Styles */
        .reminders-container {
            display: flex;
            height: 100%;
        }

        .reminders-sidebar {
            width: 200px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px 10px;
            overflow-y: auto;
        }

        .reminders-list-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 5px;
            transition: background 0.15s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reminders-list-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .reminders-list-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .reminders-count {
            font-size: 12px;
            opacity: 0.7;
            font-weight: 600;
        }

        .reminders-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .reminders-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .reminders-list {
            flex: 1;
            overflow-y: auto;
        }

        .reminder-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            transition: all 0.15s;
        }

        .reminder-item:hover {
            background: var(--border-color);
        }

        .reminder-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .reminder-checkbox:hover {
            border-color: var(--macos-blue);
        }

        .reminder-checkbox.checked {
            background: var(--macos-blue);
            border-color: var(--macos-blue);
        }

        .reminder-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .reminder-text {
            flex: 1;
            font-size: 14px;
        }

        .reminder-text.completed {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .reminder-flag {
            color: #ff9500;
            font-size: 16px;
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.15s;
        }

        .reminder-flag.flagged {
            opacity: 1;
        }

        .reminder-delete {
            color: #ff3b30;
            font-size: 16px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .reminder-item:hover .reminder-delete {
            opacity: 0.7;
        }

        .reminder-delete:hover {
            opacity: 1 !important;
        }

        .add-reminder-btn {
            padding: 12px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            background: transparent;
            color: var(--macos-blue);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-reminder-btn:hover {
            border-color: var(--macos-blue);
            background: rgba(0,122,255,0.05);
        }

        /* Apple Music Styles */
        .music-container {
            display: flex;
            height: 100%;
            flex-direction: column;
        }

        .music-main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .music-sidebar {
            width: 200px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 10px;
            overflow-y: auto;
        }

        .music-sidebar-section {
            margin-bottom: 20px;
        }

        .music-sidebar-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 8px;
            padding: 0 10px;
        }

        .music-sidebar-item {
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .music-sidebar-item:hover {
            background: var(--bg-primary);
        }

        .music-sidebar-item.active {
            background: var(--macos-blue);
            color: white;
        }

        .music-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .music-header {
            margin-bottom: 30px;
        }

        .music-header h2 {
            font-size: 32px;
            font-weight: 700;
            margin: 0 0 10px 0;
        }

        .music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        .music-album {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .music-album:hover {
            transform: translateY(-4px);
        }

        .music-album-art {
            width: 100%;
            aspect-ratio: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .music-album-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .music-album-artist {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .music-list {
            margin-top: 20px;
        }

        .music-song {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .music-song:hover {
            background: var(--bg-secondary);
        }

        .music-song.playing {
            background: rgba(0,122,255,0.1);
        }

        .music-song-number {
            width: 40px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .music-song.playing .music-song-number {
            color: var(--macos-blue);
        }

        .music-song-info {
            flex: 1;
        }

        .music-song-title {
            font-size: 14px;
            font-weight: 500;
        }

        .music-song-artist {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .music-song-duration {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .music-player {
            border-top: 1px solid var(--border-color);
            padding: 15px 20px;
            background: var(--bg-secondary);
        }

        .music-player-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .music-player-art {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .music-player-details {
            flex: 1;
        }

        .music-player-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .music-player-artist {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .music-player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
        }

        .music-control-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-primary);
            transition: color 0.15s;
            padding: 5px;
        }

        .music-control-btn:hover {
            color: var(--macos-blue);
        }

        .music-control-btn.play-pause {
            font-size: 36px;
        }

        .music-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .music-time {
            font-size: 12px;
            color: var(--text-secondary);
            min-width: 40px;
        }

        .music-progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .music-progress-fill {
            height: 100%;
            background: var(--macos-blue);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        /* Boot Screen Styles */
        .boot-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        .boot-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .boot-logo {
            font-size: 120px;
            margin-bottom: 40px;
            opacity: 0;
            animation: fadeInLogo 1s ease-in-out 0.5s forwards;
        }

        @keyframes fadeInLogo {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .boot-progress {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .boot-progress-bar {
            height: 100%;
            background: white;
            width: 0;
            animation: bootProgress 2s ease-in-out 1s forwards;
        }

        @keyframes bootProgress {
            from { width: 0; }
            to { width: 100%; }
        }

        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="1920" height="1080"><defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23667eea"/><stop offset="100%" style="stop-color:%23764ba2"/></linearGradient></defs><rect width="1920" height="1080" fill="url(%23g)"/></svg>');
            background-size: cover;
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in;
        }

        .login-screen.active {
            opacity: 1;
            pointer-events: all;
        }

        .login-time {
            font-size: 72px;
            font-weight: 200;
            color: white;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .login-date {
            font-size: 24px;
            font-weight: 400;
            color: rgba(255,255,255,0.9);
            margin-bottom: 80px;
            text-shadow: 0 1px 5px rgba(0,0,0,0.3);
        }

        .login-user {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .login-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .login-username {
            font-size: 24px;
            font-weight: 500;
            color: white;
            margin-bottom: 10px;
            text-shadow: 0 1px 5px rgba(0,0,0,0.3);
        }

        .login-password {
            width: 300px;
            padding: 12px 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 16px;
            outline: none;
            text-align: center;
            transition: all 0.3s;
        }

        .login-password:focus {
            border-color: rgba(255,255,255,0.6);
            background: rgba(255,255,255,0.25);
        }

        .login-password::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .login-button {
            margin-top: 10px;
            padding: 10px 40px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-button:hover {
            background: rgba(255,255,255,0.35);
            transform: scale(1.05);
        }

        .login-power {
            position: absolute;
            bottom: 40px;
            display: flex;
            gap: 30px;
        }

        .power-btn {
            width: 50px;
            height: 50px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .power-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.1);
        }

        /* Desktop Icons */
        .desktop-icon {
            position: absolute;
            width: 80px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.15s;
            user-select: none;
        }

        .desktop-icon:hover {
            background: rgba(255,255,255,0.15);
        }

        .desktop-icon.selected {
            background: rgba(0,122,255,0.3);
        }

        .desktop-icon-img {
            font-size: 48px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .desktop-icon-name {
            font-size: 12px;
            color: white;
            text-align: center;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            word-break: break-word;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--menu-bg);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            border: 1px solid var(--border-color);
            border-radius: 6px;
            min-width: 200px;
            padding: 4px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 15000;
            display: none;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.1s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .context-menu-item:hover {
            background: var(--macos-blue);
            color: white;
        }

        .context-menu-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .context-menu-item.disabled:hover {
            background: transparent;
            color: var(--text-primary);
        }

        .context-menu-shortcut {
            font-size: 11px;
            opacity: 0.7;
            margin-left: 20px;
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }
    </style>
</head>
<body>
    <!-- Boot Screen -->
    <div class="boot-screen" id="boot-screen">
        <div class="boot-logo"></div>
        <div class="boot-progress">
            <div class="boot-progress-bar"></div>
        </div>
    </div>

    <!-- Login Screen -->
    <div class="login-screen" id="login-screen">
        <div class="login-time" id="login-time">12:00</div>
        <div class="login-date" id="login-date">Monday, November 18</div>
        <div class="login-user">
            <div class="login-avatar">👤</div>
            <div class="login-username">User</div>
            <input type="password" class="login-password" id="login-password" placeholder="Enter Password" autocomplete="off">
            <button class="login-button" onclick="performLogin()">Login</button>
        </div>
        <div class="login-power">
            <div class="power-btn" onclick="systemSleep()" title="Sleep">💤</div>
            <div class="power-btn" onclick="systemRestart()" title="Restart">🔄</div>
            <div class="power-btn" onclick="systemShutdown()" title="Shut Down">⏻</div>
        </div>
    </div>

    <!-- Desktop -->
    <div id="desktop"></div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu"></div>

    <!-- Menu Bar -->
    <div id="menu-bar">
        <div class="menu-left">
            <div class="menu-item apple-logo">
                <span></span>
                <div class="menu-dropdown" id="apple-menu">
                    <div class="dropdown-item" onclick="showAboutMac()">About This Mac</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="launchApp('settings')">System Settings...</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="systemSleep()">Sleep</div>
                    <div class="dropdown-item" onclick="systemRestart()">Restart...</div>
                    <div class="dropdown-item" onclick="systemShutdown()">Shut Down...</div>
                </div>
            </div>
            <div class="menu-item" id="app-menu-name">Finder</div>
        </div>
        <div class="menu-right">
            <div class="menu-item" onclick="toggleSpotlight()">🔍</div>
            <div class="menu-item">🔋</div>
            <div class="menu-item">📶</div>
            <div class="menu-item" id="clock">12:00 PM</div>
        </div>
    </div>

    <!-- Windows Container -->
    <div id="windows-container"></div>

    <!-- Dock -->
    <div id="dock">
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%2300a2ff%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>📁</text></svg>')" data-app="finder"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><defs><linearGradient id=%22safari%22 x1=%220%22 y1=%220%22 x2=%221%22 y2=%221%22><stop offset=%220%25%22 stop-color=%22%2300c0ff%22/><stop offset=%22100%25%22 stop-color=%22%230080ff%22/></linearGradient></defs><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22url(%23safari)%22/><text x=%2250%22 y=%2270%22 font-size=%2250%22 text-anchor=%22middle%22 fill=%22white%22>🧭</text></svg>')" data-app="safari"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%231e1e1e%22 rx=%2215%22/><text x=%2250%22 y=%2265%22 font-size=%2255%22 text-anchor=%22middle%22 fill=%22%2300ff00%22>&gt;_</text></svg>')" data-app="terminal"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23ff9500%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>Σ</text></svg>')" data-app="calculator"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23ffd60a%22 rx=%2215%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>📝</text></svg>')" data-app="notes"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23ff3b30%22 rx=%2215%22/><text x=%2250%22 y=%2275%22 font-size=%2270%22 text-anchor=%22middle%22 fill=%22white%22>📅</text></svg>')" data-app="calendar"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><defs><linearGradient id=%22mail%22 x1=%220%22 y1=%220%22 x2=%220%22 y2=%221%22><stop offset=%220%25%22 stop-color=%22%2354b6f8%22/><stop offset=%22100%25%22 stop-color=%22%231a7ec8%22/></linearGradient></defs><rect width=%22100%22 height=%22100%22 fill=%22url(%23mail)%22 rx=%2220%22/><text x=%2250%22 y=%2275%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>✉️</text></svg>')" data-app="mail"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23a0a0a0%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>⚙️</text></svg>')" data-app="settings"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><defs><linearGradient id=%22msg%22 x1=%220%22 y1=%220%22 x2=%221%22 y2=%221%22><stop offset=%220%25%22 stop-color=%22%2300d856%22/><stop offset=%22100%25%22 stop-color=%22%2300a843%22/></linearGradient></defs><rect width=%22100%22 height=%22100%22 fill=%22url(%23msg)%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>💬</text></svg>')" data-app="messages"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23ff9500%22 rx=%2215%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>✓</text></svg>')" data-app="reminders"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><defs><linearGradient id=%22music%22 x1=%220%22 y1=%220%22 x2=%221%22 y2=%221%22><stop offset=%220%25%22 stop-color=%22%23ff006e%22/><stop offset=%22100%25%22 stop-color=%22%23ff006e%22/></linearGradient></defs><rect width=%22100%22 height=%22100%22 fill=%22url(%23music)%22 rx=%2220%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>🎵</text></svg>')" data-app="music"></div>

        <div class="dock-divider"></div>

        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23666%22 rx=%2215%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>📥</text></svg>')"></div>
        <div class="dock-item" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23888%22 rx=%2215%22/><text x=%2250%22 y=%2270%22 font-size=%2260%22 text-anchor=%22middle%22 fill=%22white%22>🗑️</text></svg>')"></div>
    </div>

    <!-- Spotlight Overlay -->
    <div class="spotlight-overlay" id="spotlight">
        <div class="spotlight-search">
            <input type="text" class="spotlight-input" id="spotlight-input" placeholder="Spotlight Search">
            <div class="spotlight-results" id="spotlight-results"></div>
        </div>
    </div>

    <script>
        // Global State
        const state = {
            windows: [],
            activeWindow: null,
            nextZIndex: 100,
            theme: 'light',
            fileSystem: {
                '/': {
                    'Desktop': {
                        type: 'folder',
                        contents: {
                            'Project Files': { type: 'folder', contents: {} },
                            'Screenshot.png': { type: 'file' }
                        }
                    },
                    'Documents': {
                        type: 'folder',
                        contents: {
                            'Resume.pdf': { type: 'file' },
                            'Work': { type: 'folder', contents: {} }
                        }
                    },
                    'Downloads': {
                        type: 'folder',
                        contents: {
                            'installer.dmg': { type: 'file' },
                            'document.pdf': { type: 'file' }
                        }
                    },
                    'Applications': {
                        type: 'folder',
                        contents: {
                            'Safari': { type: 'app' },
                            'Terminal': { type: 'app' },
                            'Calculator': { type: 'app' },
                            'Notes': { type: 'app' }
                        }
                    }
                }
            },
            terminal: {
                currentDir: '~',
                history: [],
                historyIndex: -1
            },
            notes: [
                { id: 1, title: 'Welcome to Notes', content: 'This is your first note. Start typing to edit!' },
                { id: 2, title: 'Shopping List', content: '• Milk\n• Eggs\n• Bread\n• Coffee' },
                { id: 3, title: 'Meeting Notes', content: 'Team meeting at 2 PM\nDiscuss project roadmap\nReview Q4 goals' },
                { id: 4, title: 'Ideas', content: 'Great ideas start here...' }
            ],
            activeNote: 1,
            calculator: {
                display: '0',
                previousValue: null,
                operation: null,
                waitingForOperand: false
            },
            safari: {
                tabs: [
                    { id: 1, title: 'Apple', url: 'https://www.apple.com', active: true }
                ],
                history: [],
                nextTabId: 2
            },
            mail: {
                activeFolder: 'inbox',
                activeMail: null,
                folders: {
                    inbox: [
                        { id: 1, sender: 'Apple', subject: 'Welcome to Mail', preview: 'Thank you for using Mail...', content: 'Welcome to Mail! This is a sample email to help you get started with the Mail application.' },
                        { id: 2, sender: 'System', subject: 'System Notification', preview: 'Your system is up to date', content: 'Your macOS system is running the latest version. All security updates have been applied.' },
                        { id: 3, sender: 'Newsletter', subject: 'Weekly Updates', preview: 'Check out what\'s new this week', content: 'Here are the latest updates and news from this week. Stay informed about the latest developments.' }
                    ],
                    sent: [],
                    drafts: [],
                    trash: []
                }
            },
            messages: {
                activeConversation: 1,
                conversations: [
                    {
                        id: 1,
                        name: 'Sarah Johnson',
                        avatar: '👩',
                        messages: [
                            { id: 1, text: 'Hey! How are you?', sent: false, time: '10:30 AM' },
                            { id: 2, text: 'I\'m doing great! How about you?', sent: true, time: '10:31 AM' },
                            { id: 3, text: 'Pretty good! Want to grab lunch later?', sent: false, time: '10:32 AM' },
                            { id: 4, text: 'Sure! How about 12:30?', sent: true, time: '10:33 AM' },
                            { id: 5, text: 'Perfect! See you then 😊', sent: false, time: '10:34 AM' }
                        ]
                    },
                    {
                        id: 2,
                        name: 'Work Team',
                        avatar: '💼',
                        messages: [
                            { id: 1, text: 'Meeting at 2 PM today', sent: false, time: '9:00 AM' },
                            { id: 2, text: 'Got it, I\'ll be there', sent: true, time: '9:05 AM' },
                            { id: 3, text: 'Don\'t forget to bring your reports', sent: false, time: '9:10 AM' }
                        ]
                    },
                    {
                        id: 3,
                        name: 'Family Group',
                        avatar: '👨‍👩‍👧‍👦',
                        messages: [
                            { id: 1, text: 'Dinner this Sunday?', sent: false, time: 'Yesterday' },
                            { id: 2, text: 'Sounds great! What time?', sent: true, time: 'Yesterday' },
                            { id: 3, text: 'Around 6 PM', sent: false, time: 'Yesterday' }
                        ]
                    }
                ]
            },
            reminders: {
                activeList: 'all',
                lists: [
                    { id: 'all', name: 'All', count: 5 },
                    { id: 'today', name: 'Today', count: 2 },
                    { id: 'scheduled', name: 'Scheduled', count: 3 },
                    { id: 'flagged', name: 'Flagged', count: 1 },
                    { id: 'personal', name: 'Personal', count: 2 },
                    { id: 'work', name: 'Work', count: 3 }
                ],
                items: [
                    { id: 1, text: 'Buy groceries', completed: false, flagged: false, list: 'personal', dueDate: 'today' },
                    { id: 2, text: 'Call dentist', completed: true, flagged: false, list: 'personal', dueDate: null },
                    { id: 3, text: 'Finish project report', completed: false, flagged: true, list: 'work', dueDate: 'tomorrow' },
                    { id: 4, text: 'Team meeting prep', completed: false, flagged: false, list: 'work', dueDate: 'today' },
                    { id: 5, text: 'Review code changes', completed: false, flagged: false, list: 'work', dueDate: 'tomorrow' }
                ],
                nextId: 6
            },
            music: {
                activeView: 'library',
                currentAlbum: null,
                playing: false,
                currentSong: null,
                currentTime: 0,
                albums: [
                    { id: 1, title: 'Abbey Road', artist: 'The Beatles', emoji: '🎸', songs: [
                        { id: 101, title: 'Come Together', duration: '4:20' },
                        { id: 102, title: 'Something', duration: '3:03' },
                        { id: 103, title: 'Here Comes the Sun', duration: '3:05' },
                        { id: 104, title: 'Octopus\'s Garden', duration: '2:51' }
                    ]},
                    { id: 2, title: 'Thriller', artist: 'Michael Jackson', emoji: '🕺', songs: [
                        { id: 201, title: 'Wanna Be Startin\' Somethin\'', duration: '6:03' },
                        { id: 202, title: 'Thriller', duration: '5:57' },
                        { id: 203, title: 'Beat It', duration: '4:18' },
                        { id: 204, title: 'Billie Jean', duration: '4:54' }
                    ]},
                    { id: 3, title: 'Back in Black', artist: 'AC/DC', emoji: '⚡', songs: [
                        { id: 301, title: 'Hells Bells', duration: '5:12' },
                        { id: 302, title: 'Shoot to Thrill', duration: '5:17' },
                        { id: 303, title: 'Back in Black', duration: '4:15' },
                        { id: 304, title: 'You Shook Me All Night Long', duration: '3:30' }
                    ]},
                    { id: 4, title: 'Rumours', artist: 'Fleetwood Mac', emoji: '✨', songs: [
                        { id: 401, title: 'Second Hand News', duration: '2:43' },
                        { id: 402, title: 'Dreams', duration: '4:14' },
                        { id: 403, title: 'Go Your Own Way', duration: '3:38' },
                        { id: 404, title: 'Don\'t Stop', duration: '3:11' }
                    ]},
                    { id: 5, title: 'Dark Side of the Moon', artist: 'Pink Floyd', emoji: '🌙', songs: [
                        { id: 501, title: 'Speak to Me', duration: '1:30' },
                        { id: 502, title: 'Time', duration: '6:53' },
                        { id: 503, title: 'Money', duration: '6:23' },
                        { id: 504, title: 'Us and Them', duration: '7:49' }
                    ]},
                    { id: 6, title: 'Hotel California', artist: 'Eagles', emoji: '🏨', songs: [
                        { id: 601, title: 'Hotel California', duration: '6:30' },
                        { id: 602, title: 'New Kid in Town', duration: '5:04' },
                        { id: 603, title: 'Life in the Fast Lane', duration: '4:46' },
                        { id: 604, title: 'Wasted Time', duration: '4:55' }
                    ]},
                    { id: 7, title: 'Born to Run', artist: 'Bruce Springsteen', emoji: '🏃', songs: [
                        { id: 701, title: 'Thunder Road', duration: '4:49' },
                        { id: 702, title: 'Born to Run', duration: '4:30' },
                        { id: 703, title: 'Tenth Avenue Freeze-Out', duration: '3:11' },
                        { id: 704, title: 'Jungleland', duration: '9:33' }
                    ]},
                    { id: 8, title: 'Purple Rain', artist: 'Prince', emoji: '💜', songs: [
                        { id: 801, title: 'Let\'s Go Crazy', duration: '4:39' },
                        { id: 802, title: 'When Doves Cry', duration: '5:54' },
                        { id: 803, title: 'Purple Rain', duration: '8:41' },
                        { id: 804, title: 'I Would Die 4 U', duration: '2:49' }
                    ]},
                    { id: 9, title: 'Nevermind', artist: 'Nirvana', emoji: '🎤', songs: [
                        { id: 901, title: 'Smells Like Teen Spirit', duration: '5:01' },
                        { id: 902, title: 'Come as You Are', duration: '3:38' },
                        { id: 903, title: 'Lithium', duration: '4:17' },
                        { id: 904, title: 'In Bloom', duration: '4:14' }
                    ]},
                    { id: 10, title: 'The Joshua Tree', artist: 'U2', emoji: '🌳', songs: [
                        { id: 1001, title: 'Where the Streets Have No Name', duration: '5:37' },
                        { id: 1002, title: 'With or Without You', duration: '4:56' },
                        { id: 1003, title: 'I Still Haven\'t Found What I\'m Looking For', duration: '4:37' },
                        { id: 1004, title: 'Bullet the Blue Sky', duration: '4:32' }
                    ]}
                ]
            }
        };

        // Window Management
        class WindowManager {
            static createWindow(app) {
                const windowId = 'window-' + Date.now();
                const window = document.createElement('div');
                window.className = 'window fade-in';
                window.id = windowId;
                window.style.left = (100 + state.windows.length * 30) + 'px';
                window.style.top = (50 + state.windows.length * 30) + 'px';
                window.style.width = app.width || '800px';
                window.style.height = app.height || '600px';
                window.style.zIndex = state.nextZIndex++;

                window.innerHTML = `
                    <div class="window-titlebar">
                        <div class="traffic-lights">
                            <div class="traffic-light close" onclick="WindowManager.closeWindow('${windowId}')"></div>
                            <div class="traffic-light minimize" onclick="WindowManager.minimizeWindow('${windowId}')"></div>
                            <div class="traffic-light maximize" onclick="WindowManager.toggleMaximize('${windowId}')"></div>
                        </div>
                        <div class="window-title">${app.name}</div>
                    </div>
                    ${app.toolbar ? `<div class="window-toolbar">${app.toolbar}</div>` : ''}
                    <div class="window-content" id="${windowId}-content"></div>
                    <div class="resize-handle resize-n"></div>
                    <div class="resize-handle resize-s"></div>
                    <div class="resize-handle resize-e"></div>
                    <div class="resize-handle resize-w"></div>
                    <div class="resize-handle resize-ne"></div>
                    <div class="resize-handle resize-nw"></div>
                    <div class="resize-handle resize-se"></div>
                    <div class="resize-handle resize-sw"></div>
                `;

                document.getElementById('windows-container').appendChild(window);

                // Render app content
                const content = document.getElementById(`${windowId}-content`);
                app.render(content);

                // Add drag functionality
                this.makeDraggable(window);
                this.makeResizable(window);

                // Add to state
                state.windows.push({
                    id: windowId,
                    appId: app.id,
                    element: window
                });

                this.setActiveWindow(windowId);
                this.updateDock();

                // Focus window on click
                window.addEventListener('mousedown', () => {
                    this.setActiveWindow(windowId);
                });

                return windowId;
            }

            static closeWindow(windowId) {
                const window = document.getElementById(windowId);
                if (window) {
                    window.remove();
                    state.windows = state.windows.filter(w => w.id !== windowId);
                    this.updateDock();
                }
            }

            static minimizeWindow(windowId) {
                const window = document.getElementById(windowId);
                if (window) {
                    window.classList.add('minimized');
                }
            }

            static toggleMaximize(windowId) {
                const window = document.getElementById(windowId);
                if (window) {
                    window.classList.toggle('maximized');
                }
            }

            static setActiveWindow(windowId) {
                state.windows.forEach(w => {
                    if (w.id === windowId) {
                        w.element.style.zIndex = state.nextZIndex++;
                        state.activeWindow = windowId;
                    }
                });
            }

            static makeDraggable(window) {
                const titlebar = window.querySelector('.window-titlebar');
                let isDragging = false;
                let currentX;
                let currentY;
                let initialX;
                let initialY;

                titlebar.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('traffic-light')) return;
                    if (window.classList.contains('maximized')) return;

                    isDragging = true;
                    initialX = e.clientX - window.offsetLeft;
                    initialY = e.clientY - window.offsetTop;
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        e.preventDefault();
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;

                        // Constrain window to viewport bounds
                        const menuBarHeight = 24;
                        const dockHeight = 70;
                        const minVisibleWidth = 100;
                        const minVisibleHeight = 50;

                        // Keep window within horizontal bounds
                        currentX = Math.max(-window.offsetWidth + minVisibleWidth, currentX);
                        currentX = Math.min(window.innerWidth - minVisibleWidth, currentX);

                        // Keep window within vertical bounds
                        currentY = Math.max(menuBarHeight, currentY);
                        currentY = Math.min(window.innerHeight - dockHeight - minVisibleHeight, currentY);

                        window.style.left = currentX + 'px';
                        window.style.top = currentY + 'px';
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            }

            static makeResizable(window) {
                const handles = window.querySelectorAll('.resize-handle');
                handles.forEach(handle => {
                    let isResizing = false;
                    let startX, startY, startWidth, startHeight, startLeft, startTop;

                    handle.addEventListener('mousedown', (e) => {
                        if (window.classList.contains('maximized')) return;
                        isResizing = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        startWidth = parseInt(window.style.width);
                        startHeight = parseInt(window.style.height);
                        startLeft = window.offsetLeft;
                        startTop = window.offsetTop;
                        e.stopPropagation();
                    });

                    document.addEventListener('mousemove', (e) => {
                        if (!isResizing) return;
                        e.preventDefault();

                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;
                        const minWidth = 320;
                        const minHeight = 200;

                        if (handle.classList.contains('resize-e')) {
                            const newWidth = Math.max(minWidth, startWidth + dx);
                            window.style.width = newWidth + 'px';
                        } else if (handle.classList.contains('resize-s')) {
                            const newHeight = Math.max(minHeight, startHeight + dy);
                            window.style.height = newHeight + 'px';
                        } else if (handle.classList.contains('resize-se')) {
                            const newWidth = Math.max(minWidth, startWidth + dx);
                            const newHeight = Math.max(minHeight, startHeight + dy);
                            window.style.width = newWidth + 'px';
                            window.style.height = newHeight + 'px';
                        } else if (handle.classList.contains('resize-w')) {
                            const newWidth = Math.max(minWidth, startWidth - dx);
                            const actualDx = startWidth - newWidth;
                            window.style.width = newWidth + 'px';
                            window.style.left = (startLeft + actualDx) + 'px';
                        } else if (handle.classList.contains('resize-n')) {
                            const newHeight = Math.max(minHeight, startHeight - dy);
                            const actualDy = startHeight - newHeight;
                            window.style.height = newHeight + 'px';
                            window.style.top = (startTop + actualDy) + 'px';
                        } else if (handle.classList.contains('resize-nw')) {
                            const newWidth = Math.max(minWidth, startWidth - dx);
                            const newHeight = Math.max(minHeight, startHeight - dy);
                            const actualDx = startWidth - newWidth;
                            const actualDy = startHeight - newHeight;
                            window.style.width = newWidth + 'px';
                            window.style.height = newHeight + 'px';
                            window.style.left = (startLeft + actualDx) + 'px';
                            window.style.top = (startTop + actualDy) + 'px';
                        } else if (handle.classList.contains('resize-ne')) {
                            const newWidth = Math.max(minWidth, startWidth + dx);
                            const newHeight = Math.max(minHeight, startHeight - dy);
                            const actualDy = startHeight - newHeight;
                            window.style.width = newWidth + 'px';
                            window.style.height = newHeight + 'px';
                            window.style.top = (startTop + actualDy) + 'px';
                        } else if (handle.classList.contains('resize-sw')) {
                            const newWidth = Math.max(minWidth, startWidth - dx);
                            const newHeight = Math.max(minHeight, startHeight + dy);
                            const actualDx = startWidth - newWidth;
                            window.style.width = newWidth + 'px';
                            window.style.height = newHeight + 'px';
                            window.style.left = (startLeft + actualDx) + 'px';
                        }
                    });

                    document.addEventListener('mouseup', () => {
                        isResizing = false;
                    });
                });
            }

            static updateDock() {
                document.querySelectorAll('.dock-item[data-app]').forEach(item => {
                    const appId = item.getAttribute('data-app');
                    const hasWindow = state.windows.some(w => w.appId === appId);
                    if (hasWindow) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
        }

        // Applications
        const apps = {
            finder: {
                id: 'finder',
                name: 'Finder',
                width: '900px',
                height: '600px',
                toolbar: `
                    <button class="btn" onclick="finderBack()">◀</button>
                    <button class="btn" onclick="finderForward()">▶</button>
                    <span style="flex: 1; padding: 0 15px;" id="finder-path">Desktop</span>
                    <button class="btn">⊞</button>
                    <button class="btn">⊟</button>
                    <button class="btn">≣</button>
                `,
                render: (container) => {
                    container.innerHTML = `
                        <div class="finder-container">
                            <div class="finder-sidebar">
                                <div class="sidebar-section">
                                    <div class="sidebar-title">Favorites</div>
                                    <div class="sidebar-item active" onclick="finderNavigate('Desktop')">📱 Desktop</div>
                                    <div class="sidebar-item" onclick="finderNavigate('Documents')">📄 Documents</div>
                                    <div class="sidebar-item" onclick="finderNavigate('Downloads')">📥 Downloads</div>
                                    <div class="sidebar-item" onclick="finderNavigate('Applications')">📦 Applications</div>
                                </div>
                            </div>
                            <div class="finder-main">
                                <div class="finder-items" id="finder-items"></div>
                                <div class="finder-statusbar" id="finder-status">0 items</div>
                            </div>
                        </div>
                    `;
                    finderNavigate('Desktop');
                }
            },
            safari: {
                id: 'safari',
                name: 'Safari',
                width: '1000px',
                height: '700px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="safari-container">
                            <div class="safari-tabs" id="safari-tabs"></div>
                            <div class="safari-navigation">
                                <button class="nav-btn" onclick="safariBack()">◀</button>
                                <button class="nav-btn" onclick="safariForward()">▶</button>
                                <button class="nav-btn" onclick="safariRefresh()">↻</button>
                                <input type="text" class="address-bar" id="address-bar" placeholder="Search or enter website">
                            </div>
                            <div class="safari-content" id="safari-content"></div>
                        </div>
                    `;
                    renderSafariTabs();
                    renderSafariContent();

                    document.getElementById('address-bar').addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            safariNavigate(e.target.value);
                        }
                    });
                }
            },
            terminal: {
                id: 'terminal',
                name: 'Terminal',
                width: '700px',
                height: '500px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="terminal-container" id="terminal-output">
                            <div class="terminal-line">Last login: ${new Date().toLocaleString()} on ttys000</div>
                            <div class="terminal-line">macOS Simulator Terminal v1.0</div>
                            <div class="terminal-line">Type 'help' for available commands.</div>
                            <div class="terminal-line"></div>
                            <div class="terminal-input-line">
                                <span class="terminal-prompt">user@macos ~ % </span>
                                <input type="text" class="terminal-input" id="terminal-input" autofocus>
                            </div>
                        </div>
                    `;

                    const input = document.getElementById('terminal-input');
                    input.addEventListener('keydown', handleTerminalInput);
                    input.focus();
                }
            },
            calculator: {
                id: 'calculator',
                name: 'Calculator',
                width: '320px',
                height: '500px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="calculator-container">
                            <div class="calc-display" id="calc-display">0</div>
                            <div class="calc-buttons">
                                <button class="calc-btn function" onclick="calcClear()">AC</button>
                                <button class="calc-btn function" onclick="calcToggleSign()">±</button>
                                <button class="calc-btn function" onclick="calcPercent()">%</button>
                                <button class="calc-btn operator" onclick="calcOperation('÷')">÷</button>

                                <button class="calc-btn" onclick="calcNumber('7')">7</button>
                                <button class="calc-btn" onclick="calcNumber('8')">8</button>
                                <button class="calc-btn" onclick="calcNumber('9')">9</button>
                                <button class="calc-btn operator" onclick="calcOperation('×')">×</button>

                                <button class="calc-btn" onclick="calcNumber('4')">4</button>
                                <button class="calc-btn" onclick="calcNumber('5')">5</button>
                                <button class="calc-btn" onclick="calcNumber('6')">6</button>
                                <button class="calc-btn operator" onclick="calcOperation('−')">−</button>

                                <button class="calc-btn" onclick="calcNumber('1')">1</button>
                                <button class="calc-btn" onclick="calcNumber('2')">2</button>
                                <button class="calc-btn" onclick="calcNumber('3')">3</button>
                                <button class="calc-btn operator" onclick="calcOperation('+')">+</button>

                                <button class="calc-btn" onclick="calcNumber('0')" style="grid-column: span 2;">0</button>
                                <button class="calc-btn" onclick="calcDecimal()">.</button>
                                <button class="calc-btn operator" onclick="calcEquals()">=</button>
                            </div>
                        </div>
                    `;
                }
            },
            notes: {
                id: 'notes',
                name: 'Notes',
                width: '800px',
                height: '600px',
                toolbar: `
                    <button class="btn" onclick="createNewNote()">+ New Note</button>
                    <button class="btn" onclick="deleteNote()">🗑️ Delete</button>
                `,
                render: (container) => {
                    container.innerHTML = `
                        <div class="notes-container">
                            <div class="notes-sidebar">
                                <div class="notes-list" id="notes-list"></div>
                            </div>
                            <div class="notes-editor">
                                <textarea class="notes-content" id="notes-content" placeholder="Start typing..."></textarea>
                            </div>
                        </div>
                    `;
                    renderNotesList();
                    loadNote(state.activeNote);

                    document.getElementById('notes-content').addEventListener('input', (e) => {
                        saveCurrentNote(e.target.value);
                    });
                }
            },
            settings: {
                id: 'settings',
                name: 'System Settings',
                width: '800px',
                height: '600px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="settings-container">
                            <div class="settings-sidebar">
                                <div class="settings-item active" onclick="showSettings('appearance')">🎨 Appearance</div>
                                <div class="settings-item" onclick="showSettings('desktop')">🖥️ Desktop</div>
                                <div class="settings-item" onclick="showSettings('displays')">📺 Displays</div>
                                <div class="settings-item" onclick="showSettings('sound')">🔊 Sound</div>
                                <div class="settings-item" onclick="showSettings('network')">📶 Network</div>
                            </div>
                            <div class="settings-content" id="settings-content"></div>
                        </div>
                    `;
                    showSettings('appearance');
                }
            },
            calendar: {
                id: 'calendar',
                name: 'Calendar',
                width: '900px',
                height: '650px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <div class="calendar-title" id="calendar-title"></div>
                                <div class="calendar-nav">
                                    <button class="btn" onclick="calendarPrevMonth()">◀</button>
                                    <button class="btn" onclick="calendarToday()">Today</button>
                                    <button class="btn" onclick="calendarNextMonth()">▶</button>
                                </div>
                            </div>
                            <div class="calendar-grid" id="calendar-grid"></div>
                        </div>
                    `;
                    renderCalendar();
                }
            },
            mail: {
                id: 'mail',
                name: 'Mail',
                width: '1000px',
                height: '700px',
                toolbar: `
                    <button class="btn btn-primary" onclick="composeMail()">✉️ New Message</button>
                `,
                render: (container) => {
                    container.innerHTML = `
                        <div class="mail-container">
                            <div class="mail-sidebar">
                                <div class="sidebar-item active" onclick="mailSelectFolder('inbox')">📥 Inbox</div>
                                <div class="sidebar-item" onclick="mailSelectFolder('sent')">📤 Sent</div>
                                <div class="sidebar-item" onclick="mailSelectFolder('drafts')">📝 Drafts</div>
                                <div class="sidebar-item" onclick="mailSelectFolder('trash')">🗑️ Trash</div>
                            </div>
                            <div class="mail-list" id="mail-list"></div>
                            <div class="mail-content" id="mail-content">
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
                                    Select an email to read
                                </div>
                            </div>
                        </div>
                    `;
                    renderMailList();
                }
            },
            messages: {
                id: 'messages',
                name: 'Messages',
                width: '900px',
                height: '650px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="messages-container">
                            <div class="messages-sidebar" id="messages-sidebar"></div>
                            <div class="messages-thread">
                                <div class="messages-header" id="messages-header">Select a conversation</div>
                                <div class="messages-content" id="messages-content"></div>
                                <div class="messages-input-container">
                                    <input type="text" class="messages-input" id="messages-input" placeholder="iMessage">
                                    <button class="messages-send-btn" onclick="sendMessage()">Send</button>
                                </div>
                            </div>
                        </div>
                    `;
                    renderConversations();
                }
            },
            reminders: {
                id: 'reminders',
                name: 'Reminders',
                width: '700px',
                height: '600px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="reminders-container">
                            <div class="reminders-sidebar" id="reminders-sidebar"></div>
                            <div class="reminders-main">
                                <div class="reminders-header" id="reminders-header">All</div>
                                <div class="reminders-list" id="reminders-list"></div>
                                <button class="add-reminder-btn" onclick="addNewReminder()">
                                    <span>+</span> New Reminder
                                </button>
                            </div>
                        </div>
                    `;
                    renderReminderLists();
                    renderReminders();
                }
            },
            music: {
                id: 'music',
                name: 'Music',
                width: '1000px',
                height: '700px',
                render: (container) => {
                    container.innerHTML = `
                        <div class="music-container">
                            <div class="music-main">
                                <div class="music-sidebar">
                                    <div class="music-sidebar-section">
                                        <div class="music-sidebar-title">Library</div>
                                        <div class="music-sidebar-item active" data-view="library">
                                            🎵 Albums
                                        </div>
                                        <div class="music-sidebar-item" data-view="songs">
                                            🎶 Songs
                                        </div>
                                        <div class="music-sidebar-item" data-view="artists">
                                            👨‍🎤 Artists
                                        </div>
                                    </div>
                                    <div class="music-sidebar-section">
                                        <div class="music-sidebar-title">Playlists</div>
                                        <div class="music-sidebar-item">
                                            ⭐ Favorites
                                        </div>
                                        <div class="music-sidebar-item">
                                            🔥 Top Hits
                                        </div>
                                    </div>
                                </div>
                                <div class="music-content" id="music-content"></div>
                            </div>
                            <div class="music-player" id="music-player"></div>
                        </div>
                    `;
                    renderMusicContent();
                    renderMusicPlayer();

                    // Add sidebar click handlers
                    document.querySelectorAll('.music-sidebar-item[data-view]').forEach(item => {
                        item.addEventListener('click', () => {
                            document.querySelectorAll('.music-sidebar-item').forEach(i => i.classList.remove('active'));
                            item.classList.add('active');
                            state.music.activeView = item.getAttribute('data-view');
                            renderMusicContent();
                        });
                    });
                }
            }
        };

        // App Launch
        function launchApp(appId) {
            // Check if app is already open
            const existingWindow = state.windows.find(w => w.appId === appId);
            if (existingWindow) {
                WindowManager.setActiveWindow(existingWindow.id);
                if (existingWindow.element.classList.contains('minimized')) {
                    existingWindow.element.classList.remove('minimized');
                }
                return;
            }

            const app = apps[appId];
            if (app) {
                // Bounce animation
                const dockItem = document.querySelector(`.dock-item[data-app="${appId}"]`);
                if (dockItem) {
                    dockItem.classList.add('bounce');
                    setTimeout(() => dockItem.classList.remove('bounce'), 600);
                }

                WindowManager.createWindow(app);
                document.getElementById('app-menu-name').textContent = app.name;
            }
        }

        // Finder Functions
        // Per-window Finder state storage
        const finderStates = {};

        function getFinderState(windowEl) {
            const windowId = windowEl ? windowEl.id : null;
            if (!windowId) return null;

            if (!finderStates[windowId]) {
                finderStates[windowId] = {
                    currentPath: 'Desktop',
                    history: ['Desktop'],
                    historyIndex: 0
                };
            }
            return finderStates[windowId];
        }

        function getActiveFinderWindow() {
            // Find the active Finder window
            const activeWindow = state.windows.find(w => w.appId === 'finder' && document.getElementById(w.id) === state.activeWindow);
            return activeWindow ? document.getElementById(activeWindow.id) : null;
        }

        function finderNavigate(path, addToHistory = true) {
            const windowEl = getActiveFinderWindow();
            if (!windowEl) return;

            const finderState = getFinderState(windowEl);
            finderState.currentPath = path;

            // Only modify history if this is a new navigation (not back/forward)
            if (addToHistory) {
                finderState.history = finderState.history.slice(0, finderState.historyIndex + 1);
                finderState.history.push(path);
                finderState.historyIndex = finderState.history.length - 1;
            }

            const pathEl = windowEl.querySelector('#finder-path') || windowEl.querySelector('[id^="finder-path"]');
            if (pathEl) pathEl.textContent = path;
            const items = state.fileSystem['/'][path]?.contents || {};
            const itemsContainer = windowEl.querySelector('#finder-items');

            if (!itemsContainer) return;

            itemsContainer.innerHTML = '';
            let count = 0;

            for (const [name, item] of Object.entries(items)) {
                count++;
                const icon = item.type === 'folder' ? '📁' : item.type === 'app' ? '📦' : '📄';
                const div = document.createElement('div');
                div.className = 'finder-item';
                div.innerHTML = `
                    <div class="finder-icon">${icon}</div>
                    <div class="finder-name">${name}</div>
                `;
                div.addEventListener('dblclick', () => {
                    if (item.type === 'folder') {
                        finderNavigate(name);
                    }
                });
                itemsContainer.appendChild(div);
            }

            const statusBar = windowEl.querySelector('#finder-status');
            if (statusBar) statusBar.textContent = `${count} items`;

            // Update sidebar active state within this window only
            windowEl.querySelectorAll('.finder-sidebar .sidebar-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent.includes(path)) {
                    item.classList.add('active');
                }
            });
        }

        function finderBack() {
            const windowEl = getActiveFinderWindow();
            if (!windowEl) return;

            const finderState = getFinderState(windowEl);
            if (finderState.historyIndex > 0) {
                finderState.historyIndex--;
                finderNavigate(finderState.history[finderState.historyIndex], false);
            }
        }

        function finderForward() {
            const windowEl = getActiveFinderWindow();
            if (!windowEl) return;

            const finderState = getFinderState(windowEl);
            if (finderState.historyIndex < finderState.history.length - 1) {
                finderState.historyIndex++;
                finderNavigate(finderState.history[finderState.historyIndex], false);
            }
        }

        // Safari Functions
        function renderSafariTabs() {
            const tabsContainer = document.getElementById('safari-tabs');
            tabsContainer.innerHTML = '';

            state.safari.tabs.forEach(tab => {
                const tabEl = document.createElement('div');
                tabEl.className = 'safari-tab' + (tab.active ? ' active' : '');
                tabEl.innerHTML = `
                    ${tab.title}
                    <span class="close-tab" onclick="closeSafariTab(${tab.id}, event)">×</span>
                `;
                tabEl.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('close-tab')) {
                        activateSafariTab(tab.id);
                    }
                });
                tabsContainer.appendChild(tabEl);
            });

            const newTabBtn = document.createElement('div');
            newTabBtn.className = 'new-tab-btn';
            newTabBtn.textContent = '+';
            newTabBtn.onclick = createSafariTab;
            tabsContainer.appendChild(newTabBtn);
        }

        function renderSafariContent() {
            const activeTab = state.safari.tabs.find(t => t.active);
            if (!activeTab) return;

            const content = document.getElementById('safari-content');
            document.getElementById('address-bar').value = activeTab.url;

            // Simulate different web pages
            if (activeTab.url.includes('apple.com')) {
                content.innerHTML = `
                    <h1>Welcome to Apple</h1>
                    <p>This is a simulated version of apple.com</p>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px;">
                        <div style="padding: 20px; background: var(--bg-secondary); border-radius: 10px;">
                            <h3>MacBook Pro</h3>
                            <p>The most powerful Mac ever.</p>
                        </div>
                        <div style="padding: 20px; background: var(--bg-secondary); border-radius: 10px;">
                            <h3>iPhone 15</h3>
                            <p>So advanced. So beautiful.</p>
                        </div>
                        <div style="padding: 20px; background: var(--bg-secondary); border-radius: 10px;">
                            <h3>AirPods Pro</h3>
                            <p>Rebuilt from the sound up.</p>
                        </div>
                    </div>
                `;
            } else if (activeTab.url.includes('google')) {
                content.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px;">
                        <h1 style="font-size: 72px; margin-bottom: 30px;">Google</h1>
                        <input type="text" placeholder="Search Google or type a URL" style="width: 500px; padding: 15px; border: 1px solid #ddd; border-radius: 24px; font-size: 16px;">
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <h1>Welcome to Safari</h1>
                    <p>Enter a URL or search query in the address bar above.</p>
                    <h2 style="margin-top: 40px;">Favorites</h2>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px;">
                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;" onclick="safariNavigate('https://www.apple.com')">
                            🍎 Apple
                        </div>
                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;" onclick="safariNavigate('https://www.google.com')">
                            🔍 Google
                        </div>
                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                            📰 News
                        </div>
                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;">
                            🎵 Music
                        </div>
                    </div>
                `;
            }
        }

        function createSafariTab() {
            const newTab = {
                id: state.safari.nextTabId++,
                title: 'New Tab',
                url: 'about:blank',
                active: false
            };

            state.safari.tabs.forEach(t => t.active = false);
            newTab.active = true;
            state.safari.tabs.push(newTab);

            renderSafariTabs();
            renderSafariContent();
        }

        function closeSafariTab(tabId, event) {
            event.stopPropagation();
            const index = state.safari.tabs.findIndex(t => t.id === tabId);
            if (index === -1 || state.safari.tabs.length === 1) return;

            const wasActive = state.safari.tabs[index].active;
            state.safari.tabs.splice(index, 1);

            if (wasActive && state.safari.tabs.length > 0) {
                state.safari.tabs[Math.max(0, index - 1)].active = true;
            }

            renderSafariTabs();
            renderSafariContent();
        }

        function activateSafariTab(tabId) {
            state.safari.tabs.forEach(t => t.active = t.id === tabId);
            renderSafariTabs();
            renderSafariContent();
        }

        function safariNavigate(url, addToHistory = true) {
            const activeTab = state.safari.tabs.find(t => t.active);
            if (!activeTab) return;

            // Initialize history arrays if they don't exist
            if (!activeTab.history) {
                activeTab.history = [activeTab.url];
                activeTab.historyIndex = 0;
            }

            activeTab.url = url;
            if (url.includes('apple.com')) {
                activeTab.title = 'Apple';
            } else if (url.includes('google')) {
                activeTab.title = 'Google';
            } else {
                activeTab.title = 'New Tab';
            }

            // Add to history if this is a new navigation
            if (addToHistory) {
                activeTab.history = activeTab.history.slice(0, activeTab.historyIndex + 1);
                activeTab.history.push(url);
                activeTab.historyIndex = activeTab.history.length - 1;
            }

            renderSafariTabs();
            renderSafariContent();
        }

        function safariBack() {
            const activeTab = state.safari.tabs.find(t => t.active);
            if (!activeTab || !activeTab.history) return;

            if (activeTab.historyIndex > 0) {
                activeTab.historyIndex--;
                safariNavigate(activeTab.history[activeTab.historyIndex], false);
            }
        }

        function safariForward() {
            const activeTab = state.safari.tabs.find(t => t.active);
            if (!activeTab || !activeTab.history) return;

            if (activeTab.historyIndex < activeTab.history.length - 1) {
                activeTab.historyIndex++;
                safariNavigate(activeTab.history[activeTab.historyIndex], false);
            }
        }

        function safariRefresh() {
            renderSafariContent();
        }

        // Terminal Functions
        function handleTerminalInput(e) {
            if (e.key === 'Enter') {
                const input = e.target.value.trim();
                const output = document.getElementById('terminal-output');

                // Add command to history
                state.terminal.history.push(input);
                state.terminal.historyIndex = state.terminal.history.length;

                // Echo command
                const cmdLine = document.createElement('div');
                cmdLine.className = 'terminal-line';
                cmdLine.innerHTML = `<span class="terminal-prompt">user@macos ${state.terminal.currentDir} % </span>${input}`;
                output.insertBefore(cmdLine, output.lastElementChild);

                // Execute command
                const result = executeTerminalCommand(input);
                if (result) {
                    const resultLine = document.createElement('div');
                    resultLine.className = 'terminal-line';
                    resultLine.innerHTML = result;
                    output.insertBefore(resultLine, output.lastElementChild);
                }

                // Clear input
                e.target.value = '';

                // Scroll to bottom
                output.scrollTop = output.scrollHeight;
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (state.terminal.historyIndex > 0) {
                    state.terminal.historyIndex--;
                    e.target.value = state.terminal.history[state.terminal.historyIndex];
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (state.terminal.historyIndex < state.terminal.history.length - 1) {
                    state.terminal.historyIndex++;
                    e.target.value = state.terminal.history[state.terminal.historyIndex];
                } else {
                    state.terminal.historyIndex = state.terminal.history.length;
                    e.target.value = '';
                }
            }
        }

        function executeTerminalCommand(cmd) {
            const parts = cmd.split(' ');
            const command = parts[0];
            const args = parts.slice(1);

            switch (command) {
                case 'help':
                    return `Available commands:
  ls          - list directory contents
  pwd         - print working directory
  cd [dir]    - change directory
  mkdir [dir] - create directory
  touch [file]- create file
  cat [file]  - display file contents
  echo [text] - print text
  clear       - clear terminal
  date        - show current date/time
  whoami      - show current user
  uname -a    - system information
  help        - show this help message`;

                case 'ls':
                    // List contents of current directory from file system
                    const currentPath = state.terminal.currentDir === '~' ? 'Desktop' : state.terminal.currentDir;
                    const contents = state.fileSystem['/'][currentPath]?.contents || {};
                    if (Object.keys(contents).length === 0) {
                        return ''; // Empty directory
                    }
                    return Object.keys(contents).join('  ');

                case 'pwd':
                    return `/Users/user${state.terminal.currentDir !== '~' ? '/' + state.terminal.currentDir : ''}`;

                case 'cd':
                    if (args.length === 0 || args[0] === '~') {
                        state.terminal.currentDir = '~';
                    } else {
                        state.terminal.currentDir = args[0];
                    }
                    // Update the prompt to reflect the new directory
                    setTimeout(() => {
                        const promptSpan = document.querySelector('.terminal-input-line .terminal-prompt');
                        if (promptSpan) {
                            promptSpan.textContent = `user@macos ${state.terminal.currentDir} % `;
                        }
                    }, 0);
                    return '';

                case 'mkdir':
                    return args.length > 0 ? '' : 'mkdir: missing operand';

                case 'touch':
                    return args.length > 0 ? '' : 'touch: missing file operand';

                case 'cat':
                    return args.length > 0 ? `Contents of ${args[0]}` : 'cat: missing file operand';

                case 'echo':
                    return args.join(' ');

                case 'clear':
                    setTimeout(() => {
                        const output = document.getElementById('terminal-output');
                        output.innerHTML = `
                            <div class="terminal-input-line">
                                <span class="terminal-prompt">user@macos ${state.terminal.currentDir} % </span>
                                <input type="text" class="terminal-input" id="terminal-input" autofocus>
                            </div>
                        `;
                        document.getElementById('terminal-input').addEventListener('keydown', handleTerminalInput);
                        document.getElementById('terminal-input').focus();
                    }, 0);
                    return '';

                case 'date':
                    return new Date().toString();

                case 'whoami':
                    return 'user';

                case 'uname':
                    if (args[0] === '-a') {
                        return 'Darwin MacBook-Pro.local 21.6.0 Darwin Kernel Version 21.6.0 x86_64';
                    }
                    return 'Darwin';

                case '':
                    return '';

                default:
                    return `zsh: command not found: ${command}`;
            }
        }

        // Calculator Functions
        function calcNumber(num) {
            if (state.calculator.waitingForOperand) {
                state.calculator.display = num;
                state.calculator.waitingForOperand = false;
            } else {
                state.calculator.display = state.calculator.display === '0' ? num : state.calculator.display + num;
            }
            updateCalcDisplay();
        }

        function calcOperation(op) {
            const inputValue = parseFloat(state.calculator.display);

            if (state.calculator.previousValue === null) {
                state.calculator.previousValue = inputValue;
            } else if (state.calculator.operation) {
                const result = performCalculation();
                state.calculator.display = String(result);
                state.calculator.previousValue = result;
            }

            state.calculator.waitingForOperand = true;
            state.calculator.operation = op;
            updateCalcDisplay();
        }

        function calcEquals() {
            const result = performCalculation();
            state.calculator.display = String(result);
            state.calculator.previousValue = null;
            state.calculator.operation = null;
            state.calculator.waitingForOperand = true;
            updateCalcDisplay();
        }

        function performCalculation() {
            const inputValue = parseFloat(state.calculator.display);
            const previousValue = state.calculator.previousValue;

            switch (state.calculator.operation) {
                case '+':
                    return previousValue + inputValue;
                case '−':
                    return previousValue - inputValue;
                case '×':
                    return previousValue * inputValue;
                case '÷':
                    return previousValue / inputValue;
                default:
                    return inputValue;
            }
        }

        function calcClear() {
            state.calculator.display = '0';
            state.calculator.previousValue = null;
            state.calculator.operation = null;
            state.calculator.waitingForOperand = false;
            updateCalcDisplay();
        }

        function calcToggleSign() {
            state.calculator.display = String(parseFloat(state.calculator.display) * -1);
            updateCalcDisplay();
        }

        function calcPercent() {
            state.calculator.display = String(parseFloat(state.calculator.display) / 100);
            updateCalcDisplay();
        }

        function calcDecimal() {
            if (!state.calculator.display.includes('.')) {
                state.calculator.display += '.';
                updateCalcDisplay();
            }
        }

        function updateCalcDisplay() {
            const display = document.getElementById('calc-display');
            if (display) {
                display.textContent = state.calculator.display;
            }
        }

        // Notes Functions
        function renderNotesList() {
            const list = document.getElementById('notes-list');
            list.innerHTML = '';

            state.notes.forEach(note => {
                const div = document.createElement('div');
                div.className = 'note-item' + (note.id === state.activeNote ? ' active' : '');
                div.innerHTML = `
                    <div class="note-title">${note.title}</div>
                    <div class="note-preview">${note.content.substring(0, 50)}...</div>
                `;
                div.onclick = () => loadNote(note.id);
                list.appendChild(div);
            });
        }

        function loadNote(noteId) {
            state.activeNote = noteId;
            const note = state.notes.find(n => n.id === noteId);
            if (note) {
                const content = document.getElementById('notes-content');
                if (content) {
                    content.value = note.content;
                }
                renderNotesList();
            }
        }

        function saveCurrentNote(content) {
            const note = state.notes.find(n => n.id === state.activeNote);
            if (note) {
                note.content = content;
                // Update title from first line
                const firstLine = content.split('\n')[0];
                if (firstLine) {
                    note.title = firstLine.substring(0, 30);
                }
                renderNotesList();
            }
        }

        function createNewNote() {
            const newNote = {
                id: state.notes.length + 1,
                title: 'New Note',
                content: ''
            };
            state.notes.unshift(newNote);
            loadNote(newNote.id);
        }

        function deleteNote() {
            if (state.notes.length <= 1) return;

            state.notes = state.notes.filter(n => n.id !== state.activeNote);
            loadNote(state.notes[0].id);
        }

        // Settings Functions
        function showSettings(category) {
            const content = document.getElementById('settings-content');

            // Update sidebar active state
            document.querySelectorAll('.settings-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent.toLowerCase().includes(category)) {
                    item.classList.add('active');
                }
            });

            switch (category) {
                case 'appearance':
                    content.innerHTML = `
                        <div class="settings-section">
                            <div class="settings-title">Appearance</div>
                            <div class="setting-row">
                                <div class="setting-label">Dark Mode</div>
                                <div class="toggle-switch ${state.theme === 'dark' ? 'active' : ''}" onclick="toggleTheme()"></div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-label">Accent Color</div>
                                <select class="btn" style="padding: 8px 12px;">
                                    <option>Blue</option>
                                    <option>Purple</option>
                                    <option>Pink</option>
                                    <option>Red</option>
                                    <option>Orange</option>
                                    <option>Yellow</option>
                                    <option>Green</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;

                case 'desktop':
                    content.innerHTML = `
                        <div class="settings-section">
                            <div class="settings-title">Desktop & Screen Saver</div>
                            <div class="setting-row">
                                <div class="setting-label">Show Icons on Desktop</div>
                                <div class="toggle-switch active"></div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-label">Wallpaper</div>
                                <button class="btn">Change...</button>
                            </div>
                        </div>
                    `;
                    break;

                case 'displays':
                    content.innerHTML = `
                        <div class="settings-section">
                            <div class="settings-title">Displays</div>
                            <div class="setting-row">
                                <div class="setting-label">Resolution</div>
                                <select class="btn" style="padding: 8px 12px;">
                                    <option>1920 × 1080</option>
                                    <option>2560 × 1440</option>
                                    <option>3840 × 2160</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-label">Brightness</div>
                                <input type="range" min="0" max="100" value="75" style="flex: 1;">
                            </div>
                        </div>
                    `;
                    break;

                case 'sound':
                    content.innerHTML = `
                        <div class="settings-section">
                            <div class="settings-title">Sound</div>
                            <div class="setting-row">
                                <div class="setting-label">Output Volume</div>
                                <input type="range" min="0" max="100" value="50" style="flex: 1;">
                            </div>
                            <div class="setting-row">
                                <div class="setting-label">Alert Sound</div>
                                <select class="btn" style="padding: 8px 12px;">
                                    <option>Basso</option>
                                    <option>Blow</option>
                                    <option>Bottle</option>
                                    <option>Frog</option>
                                    <option>Funk</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;

                case 'network':
                    content.innerHTML = `
                        <div class="settings-section">
                            <div class="settings-title">Network</div>
                            <div class="setting-row">
                                <div class="setting-label">Wi-Fi</div>
                                <div class="toggle-switch active"></div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-label">Connected to: Home Network</div>
                                <button class="btn">Details...</button>
                            </div>
                        </div>
                    `;
                    break;
            }
        }

        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', state.theme);
            showSettings('appearance');
        }

        // Calendar Functions
        let currentDate = new Date();

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            document.getElementById('calendar-title').textContent =
                new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            // Day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day';

                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    cell.classList.add('today');
                }

                cell.innerHTML = `<div class="calendar-day-number">${day}</div>`;
                grid.appendChild(cell);
            }
        }

        function calendarPrevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function calendarNextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function calendarToday() {
            currentDate = new Date();
            renderCalendar();
        }

        // Mail Functions
        function renderMailList() {
            const list = document.getElementById('mail-list');
            const emails = state.mail.folders[state.mail.activeFolder];

            list.innerHTML = '';
            emails.forEach(email => {
                const div = document.createElement('div');
                div.className = 'mail-item' + (email.id === state.mail.activeMail ? ' active' : '');
                div.innerHTML = `
                    <div class="mail-sender">${email.sender}</div>
                    <div class="mail-subject">${email.subject}</div>
                    <div class="mail-preview">${email.preview}</div>
                `;
                div.onclick = () => showMail(email.id);
                list.appendChild(div);
            });
        }

        function showMail(mailId) {
            state.mail.activeMail = mailId;
            const email = state.mail.folders[state.mail.activeFolder].find(e => e.id === mailId);

            if (email) {
                const content = document.getElementById('mail-content');
                content.innerHTML = `
                    <div class="mail-header">
                        <div class="mail-header-subject">${email.subject}</div>
                        <div class="mail-header-from">From: ${email.sender}</div>
                    </div>
                    <div class="mail-body">${email.content}</div>
                `;
                renderMailList();
            }
        }

        function mailSelectFolder(folder) {
            state.mail.activeFolder = folder;
            state.mail.activeMail = null;

            // Update sidebar
            document.querySelectorAll('.mail-sidebar .sidebar-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent.toLowerCase().includes(folder)) {
                    item.classList.add('active');
                }
            });

            renderMailList();

            const content = document.getElementById('mail-content');
            content.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
                    Select an email to read
                </div>
            `;
        }

        function composeMail() {
            alert('Compose mail functionality would open a new window here!');
        }

        // ========================================
        // MESSAGES APP FUNCTIONS
        // ========================================

        function renderConversations() {
            const sidebar = document.getElementById('messages-sidebar');
            sidebar.innerHTML = '';

            state.messages.conversations.forEach(conv => {
                const div = document.createElement('div');
                div.className = 'conversation-item' + (conv.id === state.messages.activeConversation ? ' active' : '');
                const lastMsg = conv.messages[conv.messages.length - 1];
                div.innerHTML = `
                    <div class="conversation-avatar">${conv.avatar}</div>
                    <div class="conversation-name">${conv.name}</div>
                    <div class="conversation-preview">${lastMsg.text}</div>
                `;
                div.onclick = () => selectConversation(conv.id);
                sidebar.appendChild(div);
            });

            // Load active conversation
            if (state.messages.activeConversation) {
                loadConversation(state.messages.activeConversation);
            }
        }

        function selectConversation(convId) {
            state.messages.activeConversation = convId;
            renderConversations();
            loadConversation(convId);
        }

        function loadConversation(convId) {
            const conv = state.messages.conversations.find(c => c.id === convId);
            if (!conv) return;

            document.getElementById('messages-header').textContent = conv.name;

            const content = document.getElementById('messages-content');
            content.innerHTML = '';

            conv.messages.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${msg.sent ? 'message-sent' : 'message-received'}`;
                bubble.innerHTML = `
                    ${msg.text}
                    <div class="message-time">${msg.time}</div>
                `;
                content.appendChild(bubble);
            });

            // Scroll to bottom
            content.scrollTop = content.scrollHeight;

            // Focus input
            document.getElementById('messages-input').focus();
        }

        function sendMessage() {
            const input = document.getElementById('messages-input');
            const text = input.value.trim();
            if (!text) return;

            const conv = state.messages.conversations.find(c => c.id === state.messages.activeConversation);
            if (!conv) return;

            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            conv.messages.push({
                id: conv.messages.length + 1,
                text: text,
                sent: true,
                time: time
            });

            input.value = '';
            loadConversation(state.messages.activeConversation);
            saveSystemState();
        }

        // Handle Enter key in messages input
        document.addEventListener('DOMContentLoaded', () => {
            const messagesInput = document.getElementById('messages-input');
            if (messagesInput) {
                messagesInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        });

        // ========================================
        // REMINDERS APP FUNCTIONS
        // ========================================

        function renderReminderLists() {
            const sidebar = document.getElementById('reminders-sidebar');
            sidebar.innerHTML = '';

            state.reminders.lists.forEach(list => {
                const div = document.createElement('div');
                div.className = 'reminders-list-item' + (list.id === state.reminders.activeList ? ' active' : '');
                div.innerHTML = `
                    <span>${list.name}</span>
                    <span class="reminders-count">${getListCount(list.id)}</span>
                `;
                div.onclick = () => selectReminderList(list.id);
                sidebar.appendChild(div);
            });
        }

        function getListCount(listId) {
            if (listId === 'all') {
                return state.reminders.items.filter(i => !i.completed).length;
            } else if (listId === 'today') {
                return state.reminders.items.filter(i => !i.completed && i.dueDate === 'today').length;
            } else if (listId === 'scheduled') {
                return state.reminders.items.filter(i => !i.completed && i.dueDate).length;
            } else if (listId === 'flagged') {
                return state.reminders.items.filter(i => !i.completed && i.flagged).length;
            } else {
                return state.reminders.items.filter(i => !i.completed && i.list === listId).length;
            }
        }

        function selectReminderList(listId) {
            state.reminders.activeList = listId;
            const listData = state.reminders.lists.find(l => l.id === listId);
            document.getElementById('reminders-header').textContent = listData.name;
            renderReminderLists();
            renderReminders();
        }

        function renderReminders() {
            const list = document.getElementById('reminders-list');
            list.innerHTML = '';

            let items = state.reminders.items;

            // Filter based on active list
            if (state.reminders.activeList === 'today') {
                items = items.filter(i => i.dueDate === 'today');
            } else if (state.reminders.activeList === 'scheduled') {
                items = items.filter(i => i.dueDate);
            } else if (state.reminders.activeList === 'flagged') {
                items = items.filter(i => i.flagged);
            } else if (state.reminders.activeList !== 'all') {
                items = items.filter(i => i.list === state.reminders.activeList);
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'reminder-item';
                div.innerHTML = `
                    <div class="reminder-checkbox ${item.completed ? 'checked' : ''}" onclick="toggleReminder(${item.id})"></div>
                    <div class="reminder-text ${item.completed ? 'completed' : ''}">${item.text}</div>
                    <div class="reminder-flag ${item.flagged ? 'flagged' : ''}" onclick="toggleFlag(${item.id})">🚩</div>
                    <div class="reminder-delete" onclick="deleteReminder(${item.id})">×</div>
                `;
                list.appendChild(div);
            });
        }

        function toggleReminder(id) {
            const item = state.reminders.items.find(i => i.id === id);
            if (item) {
                item.completed = !item.completed;
                renderReminderLists();
                renderReminders();
                saveSystemState();
            }
        }

        function toggleFlag(id) {
            const item = state.reminders.items.find(i => i.id === id);
            if (item) {
                item.flagged = !item.flagged;
                renderReminderLists();
                renderReminders();
                saveSystemState();
            }
        }

        function deleteReminder(id) {
            const index = state.reminders.items.findIndex(i => i.id === id);
            if (index > -1) {
                state.reminders.items.splice(index, 1);
                renderReminderLists();
                renderReminders();
                saveSystemState();
            }
        }

        function addNewReminder() {
            const text = prompt('New reminder:');
            if (text && text.trim()) {
                const newReminder = {
                    id: state.reminders.nextId++,
                    text: text.trim(),
                    completed: false,
                    flagged: false,
                    list: state.reminders.activeList === 'all' || state.reminders.activeList === 'today' || state.reminders.activeList === 'scheduled' || state.reminders.activeList === 'flagged' ? 'personal' : state.reminders.activeList,
                    dueDate: null
                };
                state.reminders.items.push(newReminder);
                renderReminderLists();
                renderReminders();
                saveSystemState();
            }
        }

        // Apple Music Functions
        function renderMusicContent() {
            const content = document.getElementById('music-content');
            if (!content) return;

            if (state.music.activeView === 'library' && !state.music.currentAlbum) {
                // Show all albums
                content.innerHTML = `
                    <div class="music-header">
                        <h2>Albums</h2>
                    </div>
                    <div class="music-grid"></div>
                `;

                const grid = content.querySelector('.music-grid');
                state.music.albums.forEach(album => {
                    const albumEl = document.createElement('div');
                    albumEl.className = 'music-album';
                    albumEl.innerHTML = `
                        <div class="music-album-art">${album.emoji}</div>
                        <div class="music-album-title">${album.title}</div>
                        <div class="music-album-artist">${album.artist}</div>
                    `;
                    albumEl.addEventListener('click', () => selectAlbum(album.id));
                    grid.appendChild(albumEl);
                });
            } else if (state.music.currentAlbum) {
                // Show album details and songs
                const album = state.music.albums.find(a => a.id === state.music.currentAlbum);
                if (!album) return;

                content.innerHTML = `
                    <div class="music-header">
                        <button class="btn" onclick="backToAlbums()">← Back</button>
                        <h2>${album.title}</h2>
                        <p style="color: var(--text-secondary); margin: 0;">${album.artist}</p>
                    </div>
                    <div class="music-list"></div>
                `;

                const list = content.querySelector('.music-list');
                album.songs.forEach((song, index) => {
                    const songEl = document.createElement('div');
                    songEl.className = 'music-song';
                    if (state.music.currentSong?.id === song.id) {
                        songEl.classList.add('playing');
                    }
                    songEl.innerHTML = `
                        <div class="music-song-number">${state.music.currentSong?.id === song.id ? '▶' : index + 1}</div>
                        <div class="music-song-info">
                            <div class="music-song-title">${song.title}</div>
                            <div class="music-song-artist">${album.artist}</div>
                        </div>
                        <div class="music-song-duration">${song.duration}</div>
                    `;
                    songEl.addEventListener('click', () => playSong(album, song));
                    list.appendChild(songEl);
                });
            }
        }

        function renderMusicPlayer() {
            const player = document.getElementById('music-player');
            if (!player) return;

            if (!state.music.currentSong) {
                player.innerHTML = `
                    <div class="music-player-info">
                        <div class="music-player-art">🎵</div>
                        <div class="music-player-details">
                            <div class="music-player-title">Not Playing</div>
                            <div class="music-player-artist">Select a song to play</div>
                        </div>
                    </div>
                    <div class="music-player-controls">
                        <button class="music-control-btn" disabled>⏮</button>
                        <button class="music-control-btn play-pause" disabled>▶</button>
                        <button class="music-control-btn" disabled>⏭</button>
                    </div>
                    <div class="music-progress">
                        <span class="music-time">0:00</span>
                        <div class="music-progress-bar">
                            <div class="music-progress-fill" style="width: 0%"></div>
                        </div>
                        <span class="music-time">0:00</span>
                    </div>
                `;
                return;
            }

            const album = state.music.albums.find(a => a.id === state.music.currentAlbum);
            player.innerHTML = `
                <div class="music-player-info">
                    <div class="music-player-art">${album?.emoji || '🎵'}</div>
                    <div class="music-player-details">
                        <div class="music-player-title">${state.music.currentSong.title}</div>
                        <div class="music-player-artist">${album?.artist || 'Unknown Artist'}</div>
                    </div>
                </div>
                <div class="music-player-controls">
                    <button class="music-control-btn" onclick="previousSong()">⏮</button>
                    <button class="music-control-btn play-pause" onclick="togglePlayPause()">
                        ${state.music.playing ? '⏸' : '▶'}
                    </button>
                    <button class="music-control-btn" onclick="nextSong()">⏭</button>
                </div>
                <div class="music-progress">
                    <span class="music-time">0:00</span>
                    <div class="music-progress-bar" onclick="seekMusic(event)">
                        <div class="music-progress-fill" style="width: 0%"></div>
                    </div>
                    <span class="music-time">${state.music.currentSong.duration}</span>
                </div>
            `;
        }

        function selectAlbum(albumId) {
            state.music.currentAlbum = albumId;
            renderMusicContent();
        }

        function backToAlbums() {
            state.music.currentAlbum = null;
            renderMusicContent();
        }

        function playSong(album, song) {
            state.music.currentSong = song;
            state.music.currentAlbum = album.id;
            state.music.playing = true;
            state.music.currentTime = 0;
            renderMusicContent();
            renderMusicPlayer();
        }

        let musicPlaybackInterval = null;

        function togglePlayPause() {
            state.music.playing = !state.music.playing;

            if (state.music.playing) {
                startMusicPlayback();
            } else {
                stopMusicPlayback();
            }

            renderMusicPlayer();
        }

        function startMusicPlayback() {
            if (musicPlaybackInterval) clearInterval(musicPlaybackInterval);

            // Update progress every 500ms
            musicPlaybackInterval = setInterval(() => {
                if (!state.music.playing) {
                    stopMusicPlayback();
                    return;
                }

                // Simulate playback (3 minutes = 180 seconds)
                state.music.currentTime += 0.005; // Increment by 0.5%

                if (state.music.currentTime >= 1) {
                    // Song finished, play next
                    state.music.currentTime = 0;
                    stopMusicPlayback();
                    nextSong();
                    return;
                }

                // Update progress bar
                const progressFill = document.querySelector('.music-progress-fill');
                if (progressFill) {
                    progressFill.style.width = (state.music.currentTime * 100) + '%';
                }
            }, 500);
        }

        function stopMusicPlayback() {
            if (musicPlaybackInterval) {
                clearInterval(musicPlaybackInterval);
                musicPlaybackInterval = null;
            }
        }

        function nextSong() {
            const album = state.music.albums.find(a => a.id === state.music.currentAlbum);
            if (!album || !state.music.currentSong) return;

            const currentIndex = album.songs.findIndex(s => s.id === state.music.currentSong.id);
            if (currentIndex < album.songs.length - 1) {
                playSong(album, album.songs[currentIndex + 1]);
            }
        }

        function previousSong() {
            const album = state.music.albums.find(a => a.id === state.music.currentAlbum);
            if (!album || !state.music.currentSong) return;

            const currentIndex = album.songs.findIndex(s => s.id === state.music.currentSong.id);
            if (currentIndex > 0) {
                playSong(album, album.songs[currentIndex - 1]);
            }
        }

        function seekMusic(event) {
            const bar = event.currentTarget;
            const rect = bar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            state.music.currentTime = percent;
            bar.querySelector('.music-progress-fill').style.width = (percent * 100) + '%';
        }

        // Spotlight Search
        function toggleSpotlight() {
            const spotlight = document.getElementById('spotlight');
            spotlight.classList.toggle('active');

            if (spotlight.classList.contains('active')) {
                const input = document.getElementById('spotlight-input');
                input.value = '';
                input.focus();
                updateSpotlightResults('');
            }
        }

        document.getElementById('spotlight-input').addEventListener('input', (e) => {
            updateSpotlightResults(e.target.value);
        });

        document.getElementById('spotlight-input').addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                toggleSpotlight();
            } else if (e.key === 'Enter') {
                const results = document.querySelectorAll('.spotlight-result');
                if (results.length > 0) {
                    const selected = document.querySelector('.spotlight-result.selected') || results[0];
                    const appId = selected.getAttribute('data-app');
                    if (appId) {
                        launchApp(appId);
                        toggleSpotlight();
                    }
                }
            }
        });

        function updateSpotlightResults(query) {
            const results = document.getElementById('spotlight-results');

            if (!query) {
                results.innerHTML = '';
                return;
            }

            const searchableApps = Object.values(apps).filter(app =>
                app.name.toLowerCase().includes(query.toLowerCase())
            );

            results.innerHTML = '';
            searchableApps.forEach((app, index) => {
                const div = document.createElement('div');
                div.className = 'spotlight-result' + (index === 0 ? ' selected' : '');
                div.setAttribute('data-app', app.id);
                div.innerHTML = `
                    <div class="spotlight-icon">📦</div>
                    <div>
                        <div style="font-weight: 600;">${app.name}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Application</div>
                    </div>
                `;
                div.onclick = () => {
                    launchApp(app.id);
                    toggleSpotlight();
                };
                results.appendChild(div);
            });
        }

        // Menu Bar Functions
        document.querySelector('.apple-logo').addEventListener('click', (e) => {
            e.stopPropagation();
            const menu = document.getElementById('apple-menu');
            menu.classList.toggle('active');
        });

        document.addEventListener('click', () => {
            document.querySelectorAll('.menu-dropdown').forEach(menu => {
                menu.classList.remove('active');
            });
        });

        function showAboutMac() {
            alert('macOS Simulator v1.0\nBuilt with HTML, CSS, and JavaScript\n\n© 2024 macOS Simulator');
        }

        function systemSleep() {
            alert('Sleep functionality would dim the screen here!');
        }

        function systemRestart() {
            if (confirm('Are you sure you want to restart?')) {
                location.reload();
            }
        }

        function systemShutdown() {
            if (confirm('Are you sure you want to shut down?')) {
                document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: black; color: white; font-size: 24px;">Shutting down...</div>';
            }
        }

        // Clock Update
        function updateClock() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            const displayMinutes = minutes < 10 ? '0' + minutes : minutes;

            document.getElementById('clock').textContent =
                `${displayHours}:${displayMinutes} ${ampm}`;
        }

        setInterval(updateClock, 1000);
        updateClock();

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            // Cmd+Space for Spotlight
            if ((e.metaKey || e.ctrlKey) && e.code === 'Space') {
                e.preventDefault();
                toggleSpotlight();
            }
        });

        // Close spotlight when clicking outside
        document.getElementById('spotlight').addEventListener('click', (e) => {
            if (e.target.id === 'spotlight') {
                toggleSpotlight();
            }
        });

        // ========================================
        // PHASE 1: BOOT, LOGIN & DESKTOP ICONS
        // ========================================

        // Desktop Icons State
        const desktopIcons = [
            { id: 1, name: 'Documents', icon: '📄', x: 20, y: 20 },
            { id: 2, name: 'Projects', icon: '📁', x: 20, y: 140 },
            { id: 3, name: 'Screenshots', icon: '📸', x: 20, y: 260 }
        ];

        let selectedIcon = null;
        let draggingIcon = null;

        // Boot Sequence
        function startBootSequence() {
            const bootScreen = document.getElementById('boot-screen');
            const loginScreen = document.getElementById('login-screen');
            const logo = document.querySelector('.boot-logo');

            // Set Apple logo
            logo.textContent = '';

            // Hide menu bar and dock initially
            document.getElementById('menu-bar').style.opacity = '0';
            document.getElementById('dock').style.opacity = '0';
            document.getElementById('desktop').style.opacity = '0';

            // Wait for boot animation to complete (3.5s)
            setTimeout(() => {
                bootScreen.classList.add('hidden');

                // Show login screen
                setTimeout(() => {
                    loginScreen.classList.add('active');
                    updateLoginTime();

                    // Auto-focus password field
                    document.getElementById('login-password').focus();
                }, 500);
            }, 3500);
        }

        // Update Login Time
        function updateLoginTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const displayHours = hours % 12 || 12;
            const displayMinutes = minutes < 10 ? '0' + minutes : minutes;

            const timeEl = document.getElementById('login-time');
            const dateEl = document.getElementById('login-date');

            if (timeEl) timeEl.textContent = `${displayHours}:${displayMinutes}`;

            if (dateEl) {
                const options = { weekday: 'long', month: 'long', day: 'numeric' };
                dateEl.textContent = now.toLocaleDateString('en-US', options);
            }
        }

        // Perform Login
        function performLogin() {
            const loginScreen = document.getElementById('login-screen');

            // Fade out login screen
            loginScreen.classList.remove('active');

            setTimeout(() => {
                // Show desktop elements
                document.getElementById('menu-bar').style.opacity = '1';
                document.getElementById('menu-bar').style.transition = 'opacity 0.5s';
                document.getElementById('dock').style.opacity = '1';
                document.getElementById('dock').style.transition = 'opacity 0.5s';
                document.getElementById('desktop').style.opacity = '1';
                document.getElementById('desktop').style.transition = 'opacity 0.5s';

                // Render desktop icons
                renderDesktopIcons();

                // Load saved state
                loadSystemState();

                // Fix Apple logo
                const appleLogo = document.querySelector('.apple-logo span');
                if (appleLogo) appleLogo.textContent = '';
            }, 500);
        }

        // Handle Enter key on login
        document.addEventListener('DOMContentLoaded', () => {
            const loginPassword = document.getElementById('login-password');
            if (loginPassword) {
                loginPassword.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        performLogin();
                    }
                });
            }
        });

        // Desktop Icons Functions
        function renderDesktopIcons() {
            const desktop = document.getElementById('desktop');

            // Clear existing icons
            const existingIcons = desktop.querySelectorAll('.desktop-icon');
            existingIcons.forEach(icon => icon.remove());

            // Render icons
            desktopIcons.forEach(iconData => {
                const icon = createDesktopIcon(iconData);
                desktop.appendChild(icon);
            });
        }

        function createDesktopIcon(data) {
            const icon = document.createElement('div');
            icon.className = 'desktop-icon';
            icon.id = `desktop-icon-${data.id}`;
            icon.style.left = `${data.x}px`;
            icon.style.top = `${data.y}px`;

            icon.innerHTML = `
                <div class="desktop-icon-img">${data.icon}</div>
                <div class="desktop-icon-name">${data.name}</div>
            `;

            // Click to select
            icon.addEventListener('click', (e) => {
                e.stopPropagation();
                selectDesktopIcon(data.id);
            });

            // Double-click to open
            icon.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                alert(`Opening ${data.name}...`);
            });

            // Drag to move
            icon.addEventListener('mousedown', (e) => {
                if (e.button === 0) { // Left click only
                    startDragIcon(data.id, e);
                }
            });

            // Right-click context menu
            icon.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e.clientX, e.clientY, 'icon', data);
            });

            return icon;
        }

        function selectDesktopIcon(id) {
            // Deselect all
            document.querySelectorAll('.desktop-icon').forEach(icon => {
                icon.classList.remove('selected');
            });

            // Select this one
            const icon = document.getElementById(`desktop-icon-${id}`);
            if (icon) {
                icon.classList.add('selected');
                selectedIcon = id;
            }
        }

        function startDragIcon(id, e) {
            draggingIcon = id;
            const icon = document.getElementById(`desktop-icon-${id}`);
            if (!icon) return;

            const rect = icon.getBoundingClientRect();
            const offsetX = e.clientX - rect.left;
            const offsetY = e.clientY - rect.top;

            function onMouseMove(e) {
                if (!draggingIcon) return;

                const desktop = document.getElementById('desktop');
                const desktopRect = desktop.getBoundingClientRect();

                let x = e.clientX - desktopRect.left - offsetX;
                let y = e.clientY - desktopRect.top - offsetY;

                // Constrain to desktop bounds
                x = Math.max(0, Math.min(x, desktopRect.width - 80));
                y = Math.max(0, Math.min(y, desktopRect.height - 100));

                icon.style.left = `${x}px`;
                icon.style.top = `${y}px`;

                // Update data
                const iconData = desktopIcons.find(i => i.id === draggingIcon);
                if (iconData) {
                    iconData.x = x;
                    iconData.y = y;
                }
            }

            function onMouseUp() {
                // Snap to grid on release
                const gridSizeX = 100;
                const gridSizeY = 120;

                const iconData = desktopIcons.find(i => i.id === draggingIcon);
                if (iconData) {
                    // Round to nearest grid position
                    iconData.x = Math.round(iconData.x / gridSizeX) * gridSizeX;
                    iconData.y = Math.round(iconData.y / gridSizeY) * gridSizeY;

                    // Update visual position to snapped position
                    icon.style.left = `${iconData.x}px`;
                    icon.style.top = `${iconData.y}px`;
                }

                draggingIcon = null;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                saveSystemState();
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        // Deselect icon when clicking desktop
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('desktop').addEventListener('click', () => {
                document.querySelectorAll('.desktop-icon').forEach(icon => {
                    icon.classList.remove('selected');
                });
                selectedIcon = null;
            });

            // Desktop right-click
            document.getElementById('desktop').addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e.clientX, e.clientY, 'desktop');
            });
        });

        // Context Menu
        function showContextMenu(x, y, type, data = null) {
            const menu = document.getElementById('context-menu');

            let menuItems = '';

            if (type === 'desktop') {
                menuItems = `
                    <div class="context-menu-item" onclick="createNewFolder()">
                        New Folder
                    </div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item" onclick="hideContextMenu()">
                        Get Info<span class="context-menu-shortcut">⌘I</span>
                    </div>
                    <div class="context-menu-item" onclick="hideContextMenu()">
                        Change Desktop Background...
                    </div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item" onclick="hideContextMenu()">
                        Use Stacks
                    </div>
                    <div class="context-menu-item" onclick="hideContextMenu()">
                        Sort By
                    </div>
                `;
            } else if (type === 'icon') {
                menuItems = `
                    <div class="context-menu-item" onclick="hideContextMenu()">
                        Open
                    </div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item" onclick="hideContextMenu()">
                        Get Info<span class="context-menu-shortcut">⌘I</span>
                    </div>
                    <div class="context-menu-item" onclick="renameIcon(${data.id})">
                        Rename
                    </div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item" onclick="deleteIcon(${data.id})">
                        Move to Trash<span class="context-menu-shortcut">⌘⌫</span>
                    </div>
                `;
            }

            menu.innerHTML = menuItems;
            menu.classList.add('active');

            // Position menu and check for viewport overflow
            const menuRect = menu.getBoundingClientRect();
            let left = x;
            let top = y;

            // Adjust if menu would go off-screen horizontally
            if (left + menuRect.width > window.innerWidth) {
                left = window.innerWidth - menuRect.width - 10;
            }

            // Adjust if menu would go off-screen vertically
            if (top + menuRect.height > window.innerHeight) {
                top = window.innerHeight - menuRect.height - 10;
            }

            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;

            // Close on click elsewhere
            setTimeout(() => {
                document.addEventListener('click', hideContextMenu, { once: true });
            }, 100);
        }

        function hideContextMenu() {
            const menu = document.getElementById('context-menu');
            menu.classList.remove('active');
        }

        function createNewFolder() {
            const newIcon = {
                id: desktopIcons.length + 1,
                name: 'Untitled Folder',
                icon: '📁',
                x: 20,
                y: 20 + desktopIcons.length * 120
            };
            desktopIcons.push(newIcon);
            renderDesktopIcons();
            saveSystemState();
            hideContextMenu();
        }

        function renameIcon(id) {
            const iconData = desktopIcons.find(i => i.id === id);
            if (iconData) {
                const newName = prompt('Enter new name:', iconData.name);
                if (newName && newName.trim()) {
                    iconData.name = newName.trim();
                    renderDesktopIcons();
                    saveSystemState();
                }
            }
            hideContextMenu();
        }

        function deleteIcon(id) {
            const index = desktopIcons.findIndex(i => i.id === id);
            if (index > -1) {
                desktopIcons.splice(index, 1);
                renderDesktopIcons();
                saveSystemState();
            }
            hideContextMenu();
        }

        // ========================================
        // ENHANCED WINDOW MANAGEMENT
        // ========================================

        // Update WindowManager for improved functionality
        const originalCreateWindow = WindowManager.createWindow;
        WindowManager.createWindow = function(app) {
            const windowId = originalCreateWindow.call(this, app);
            const window = document.getElementById(windowId);

            if (!window) return windowId;

            // Add minimum size constraints
            window.style.minWidth = '320px';
            window.style.minHeight = '200px';

            // Double-click titlebar to maximize
            const titlebar = window.querySelector('.window-titlebar');
            titlebar.addEventListener('dblclick', (e) => {
                if (!e.target.classList.contains('traffic-light')) {
                    WindowManager.toggleMaximize(windowId);
                }
            });

            // Store original position/size for restore
            if (!window.dataset.originalSize) {
                window.dataset.originalSize = JSON.stringify({
                    width: window.style.width,
                    height: window.style.height,
                    left: window.style.left,
                    top: window.style.top
                });
            }

            return windowId;
        };

        // Improved minimize with dock animation
        const originalMinimize = WindowManager.minimizeWindow;
        WindowManager.minimizeWindow = function(windowId) {
            const window = document.getElementById(windowId);
            if (!window) return;

            // Get dock icon position
            const windowData = state.windows.find(w => w.id === windowId);
            if (!windowData) return;

            const dockItem = document.querySelector(`.dock-item[data-app="${windowData.appId}"]`);

            if (dockItem) {
                const windowRect = window.getBoundingClientRect();
                const dockRect = dockItem.getBoundingClientRect();

                // Calculate transform
                const scaleX = dockRect.width / windowRect.width;
                const scaleY = dockRect.height / windowRect.height;
                const translateX = dockRect.left - windowRect.left;
                const translateY = dockRect.top - windowRect.top;

                // Animate to dock
                window.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                window.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scaleX}, ${scaleY})`;
                window.style.opacity = '0';

                setTimeout(() => {
                    window.style.transition = '';
                    window.style.transform = '';
                    window.style.opacity = '';
                    window.classList.add('minimized');

                    // Add minimized indicator to dock
                    dockItem.classList.add('has-minimized');
                }, 400);
            } else {
                originalMinimize.call(this, windowId);
            }
        };

        // Restore minimized window
        WindowManager.restoreWindow = function(windowId) {
            const window = document.getElementById(windowId);
            if (!window) return;

            window.classList.remove('minimized');
            this.setActiveWindow(windowId);

            const windowData = state.windows.find(w => w.id === windowId);
            if (windowData) {
                const dockItem = document.querySelector(`.dock-item[data-app="${windowData.appId}"]`);
                if (dockItem) {
                    dockItem.classList.remove('has-minimized');
                }
            }
        };

        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // CMD/CTRL + W - Close active window
            if ((e.metaKey || e.ctrlKey) && e.key === 'w') {
                e.preventDefault();
                if (state.activeWindow) {
                    const activeWindowData = state.windows.find(w => document.getElementById(w.id) === state.activeWindow);
                    if (activeWindowData) {
                        WindowManager.closeWindow(activeWindowData.id);
                    }
                }
            }

            // CMD/CTRL + M - Minimize active window
            if ((e.metaKey || e.ctrlKey) && e.key === 'm') {
                e.preventDefault();
                if (state.activeWindow) {
                    const activeWindowData = state.windows.find(w => document.getElementById(w.id) === state.activeWindow);
                    if (activeWindowData) {
                        WindowManager.minimizeWindow(activeWindowData.id);
                    }
                }
            }

            // CMD/CTRL + N - New Finder window
            if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
                e.preventDefault();
                launchApp('finder');
            }
        });

        // Update dock click to restore minimized windows
        // Use event delegation to avoid multiple listeners
        let dockInitialized = false;

        document.addEventListener('DOMContentLoaded', () => {
            if (dockInitialized) return;
            dockInitialized = true;

            // Remove inline onclick attributes first
            document.querySelectorAll('.dock-item[data-app]').forEach(item => {
                item.removeAttribute('onclick');
            });

            // Use event delegation on the dock container
            const dock = document.getElementById('dock');
            if (dock) {
                dock.addEventListener('click', (e) => {
                    const dockItem = e.target.closest('.dock-item[data-app]');
                    if (!dockItem) return;

                    const appId = dockItem.getAttribute('data-app');
                    const existingWindow = state.windows.find(w => w.appId === appId);

                    if (existingWindow) {
                        if (existingWindow.element.classList.contains('minimized')) {
                            WindowManager.restoreWindow(existingWindow.id);
                        } else {
                            WindowManager.setActiveWindow(existingWindow.id);
                        }
                    } else {
                        launchApp(appId);
                    }
                });
            }
        });

        // ========================================
        // LOCALSTORAGE PERSISTENCE
        // ========================================

        function saveSystemState() {
            const stateToSave = {
                desktopIcons: desktopIcons,
                theme: state.theme,
                notes: state.notes,
                timestamp: Date.now()
            };

            try {
                localStorage.setItem('macos-simulator-state', JSON.stringify(stateToSave));
            } catch (e) {
                console.warn('Failed to save state:', e);
            }
        }

        function loadSystemState() {
            try {
                const saved = localStorage.getItem('macos-simulator-state');
                if (saved) {
                    const data = JSON.parse(saved);

                    // Restore desktop icons
                    if (data.desktopIcons) {
                        desktopIcons.length = 0;
                        desktopIcons.push(...data.desktopIcons);
                        renderDesktopIcons();
                    }

                    // Restore theme
                    if (data.theme) {
                        state.theme = data.theme;
                        document.body.setAttribute('data-theme', data.theme);
                    }

                    // Restore notes
                    if (data.notes) {
                        state.notes = data.notes;
                    }
                }
            } catch (e) {
                console.warn('Failed to load state:', e);
            }
        }

        // Save state periodically
        setInterval(saveSystemState, 30000); // Every 30 seconds

        // Save on unload
        window.addEventListener('beforeunload', saveSystemState);

        // Initialize
        console.log('macOS Simulator v2.0 loaded successfully!');
        console.log('Starting boot sequence...');

        // Start boot sequence on load
        window.addEventListener('load', () => {
            startBootSequence();
        });
    </script>
</body>
</html>